<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News AI - Demo</title>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--bg);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Login Page */
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        .login-container h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Control Panel */
        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .control-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Topics Grid */
        .topics-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        /* Topic Card */
        .topic-card {
            position: relative;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border);
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .topic-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            flex: 1;
        }

        .topic-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .topic-tag {
            display: inline-block;
            padding: 0.25rem 0.625rem;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 400;
        }

        /* Categories Section */
        .categories-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Category Card */
        .category-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 0.625rem 0.875rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        .category-title {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--primary);
            min-width: fit-content;
            padding-right: 0.75rem;
            border-right: 2px solid var(--border);
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            white-space: nowrap;
        }

        .category-content {
            flex: 1;
            min-width: 0;
        }

        /* Social Feed Cards Grid */
        .social-feed-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Social Feed Card */
        .social-feed-card {
            position: relative;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* Copy button style (inline in actions) */
        .card-copy-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 8px;
            background: var(--primary);
            color: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
        }

        .social-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .social-feed-handle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .social-feed-handle-info {
            display: flex;
            flex-direction: column;
        }

        .social-feed-handle-name {
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
        }

        .social-feed-handle-username {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Social Section - now merged with categories */
        .social-sort-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .social-posts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .social-post-row {
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .social-post-row:hover {
            background: var(--card-bg);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .social-post-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .social-post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .empty-topics {
            text-align: center;
            padding: 1rem;
            color: var(--text-light);
            font-size: 0.75rem;
        }

        /* Topics List */
        .topics-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Topic Row */
        .topic-row {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
            padding: 0.5rem 0.625rem;
            background: var(--bg);
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .topic-row:hover {
            background: var(--card-bg);
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .topic-row-first {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .topic-row-name {
            flex: 1;
            font-weight: 600;
            color: var(--text);
            font-size: 0.75rem;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .topic-row-second {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            width: 100%;
        }

        .topic-row-tags {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }

        .topic-tag-small {
            display: inline-block;
            padding: 0.125rem 0.35rem;
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.625rem;
            font-weight: 400;
            white-space: nowrap;
        }

        .topic-row-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .btn-icon-small {
            padding: 0.2rem 0.3rem;
            font-size: 0.7rem;
        }

        .topic-summary {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .topic-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.8125rem;
            color: var(--text-light);
        }

        .topic-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--bg);
        }

        .btn-icon.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-feedback-active {
            background: var(--bg) !important;
            border-color: var(--primary) !important;
            border-width: 2px !important;
        }

        .btn-feedback-up.btn-feedback-active {
            background: rgba(16, 185, 129, 0.1) !important;
            border-color: var(--success) !important;
        }

        .btn-feedback-down.btn-feedback-active {
            background: rgba(239, 68, 68, 0.1) !important;
            border-color: var(--danger) !important;
        }

        /* News Items */
        .news-items {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .news-item {
            padding: 0.75rem;
            border-left: 3px solid var(--primary);
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .news-item-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .news-item-meta {
            font-size: 0.75rem;
            color: var(--text-light);
            display: flex;
            gap: 0.75rem;
            margin-top: 0.25rem;
        }

        .news-item-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.75rem;
        }

        .news-item-link:hover {
            text-decoration: underline;
        }

        /* Preferences Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Topic Modal */
        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg);
            color: var(--text);
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .modal-summary {
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .modal-summary strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .modal-summary p {
            color: var(--text-light);
            line-height: 1.6;
            margin: 0;
        }

        .modal-news {
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
        }

        .modal-news strong {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--text);
        }

        .news-links {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .news-links li {
            padding: 0.75rem;
            background: var(--card-bg);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .news-links li a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            display: block;
            margin-bottom: 0.25rem;
        }

        .news-links li a:hover {
            text-decoration: underline;
        }

        .news-link-desc {
            display: block;
            font-size: 0.8125rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        .modal-score {
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            border-top: 2px solid var(--border);
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-score strong {
            color: var(--text);
            font-size: 0.9375rem;
        }

        .modal-score span {
            color: var(--primary);
            font-weight: 600;
            font-size: 1.125rem;
        }
            border-radius: 6px;
        }

        .close-btn:hover {
            background: var(--bg);
        }

        /* Messages - Toast Style */
        .message {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.875rem 1.25rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            min-width: 250px;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
            font-size: 0.875rem;
            font-weight: 500;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .message-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .message-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #2563eb;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .topics-grid {
                grid-template-columns: 1fr;
            }

            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }

            .categories-section {
                grid-template-columns: 1fr;
            }

            .category-card {
                flex-direction: column;
                gap: 0.5rem;
            }


            .category-title {
                padding-right: 0;
                padding-bottom: 0.5rem;
                border-right: none;
                border-bottom: 2px solid var(--border);
            }

            .topic-row-second {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .topic-row-tags {
                width: 100%;
            }

            .topic-row-actions {
                align-self: flex-end;
            }

            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .categories-section {
                grid-template-columns: 1fr;
            }
        }

        @media (min-width: 1025px) {
            .categories-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .social-feed-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .social-feed-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [userRole, setUserRole] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [topicsByCategory, setTopicsByCategory] = useState({});
            const [categories, setCategories] = useState([]);
            const [timeframe, setTimeframe] = useState('24h');
            const [loadingTopics, setLoadingTopics] = useState({});
            const [topicFeedback, setTopicFeedback] = useState({}); // Track feedback: { topicId: 'up' | 'down' }
            const [showPreferences, setShowPreferences] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [currentRoute, setCurrentRoute] = useState('discovery'); // 'discovery', 'social', 'draft', 'writer'
            const [drafts, setDrafts] = useState([]); // Array of topic objects
            const [socialHandles, setSocialHandles] = useState([]);
            const [socialFeeds, setSocialFeeds] = useState({}); // { handleId: { handle, posts, sort } }
            const [loadingSocial, setLoadingSocial] = useState(false);
            const [socialTimeframe, setSocialTimeframe] = useState('24h'); // Default: past 24 hours
            const [socialSort, setSocialSort] = useState('publishedAt'); // Default: sort by publishedAt (首發時間)
            const [socialPostDrafts, setSocialPostDrafts] = useState([]); // Array of social post objects
            const [lastAutoFetchTime, setLastAutoFetchTime] = useState(null);
            const [pendingWriterJobId, setPendingWriterJobId] = useState(null);
            const [preferences, setPreferences] = useState({
                sources: [],
                categories: [],
                defaultTimeframe: '24h',
                socialHandlesOrder: []
            });

            // Load 素材夾 from API when logged in (persisted to DB)
            const loadMaterials = async () => {
                const token = localStorage.getItem('jwt_token');
                if (!token) return;
                try {
                    const res = await fetch('/api/materials', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setDrafts(data.data?.topics || []);
                        setSocialPostDrafts(data.data?.socialPosts || []);
                    }
                } catch (e) {
                    console.error('Failed to load materials:', e);
                }
            };

            // Add social post to draft (persisted to DB)
            const handleAddSocialPostToDraft = async (post) => {
                const exists = socialPostDrafts.some(d =>
                    d._id === post._id ||
                    (d.externalId === post.externalId && d.platform === post.platform)
                );
                if (exists) {
                    showMessage('此貼文已在素材夾中', 'info');
                    return;
                }
                if (!post._id) {
                    showMessage('此貼文無法加入素材夾', 'error');
                    return;
                }
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    showMessage('請先登入', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/materials/social-posts', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ socialPostId: post._id })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setSocialPostDrafts(prev => [...prev, post]);
                        showMessage('已加入素材夾', 'success');
                    } else {
                        showMessage(data.message || '加入失敗', 'error');
                    }
                } catch (e) {
                    showMessage('加入失敗: ' + e.message, 'error');
                }
            };

            // Check if user is logged in on mount
            useEffect(() => {
                const token = localStorage.getItem('jwt_token');
                const role = localStorage.getItem('user_role');
                if (token && role) {
                    setIsLoggedIn(true);
                    setUserRole(role);
                    // Load user info first to get feedback, then preferences, then 素材夾 from DB
                    loadUserInfo().then(() => {
                        loadPreferences().then(() => loadMaterials());
                    });
                }
            }, []);

            // Load user info and feedback
            const loadUserInfo = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setCurrentUser(data.data);
                        setUserRole(data.data.role);
                        localStorage.setItem('user_role', data.data.role);
                        
                        // Load feedback from user preferences
                        if (data.data.topicPreferences) {
                            const feedbackMap = {};
                            const likedTopics = data.data.topicPreferences.likedTopics || [];
                            const dislikedTopics = data.data.topicPreferences.dislikedTopics || [];
                            
                            // Handle both ObjectId objects and strings
                            likedTopics.forEach(topicId => {
                                const id = topicId._id ? topicId._id.toString() : topicId.toString();
                                feedbackMap[id] = 'up';
                            });
                            dislikedTopics.forEach(topicId => {
                                const id = topicId._id ? topicId._id.toString() : topicId.toString();
                                feedbackMap[id] = 'down';
                            });
                            
                            setTopicFeedback(feedbackMap);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load user info:', error);
                }
            };

            // Load preferences
            const loadPreferences = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/preferences', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setPreferences(data.data);
                        // Categories are now objects with name and displayName
                        const cats = data.data.categories || [];
                        setCategories(cats);
                        setTimeframe(data.data.defaultTimeframe || '24h');
                        // Load topics for all categories
                        if (cats.length > 0) {
                            loadAllTopics(cats);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load preferences:', error);
                }
            };

            // Login
            const handleLogin = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const username = formData.get('username');
                const password = formData.get('password');

                setLoading(true);
                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await res.json();
                    if (res.ok && data.token) {
                        localStorage.setItem('jwt_token', data.token);
                        localStorage.setItem('user_role', data.user.role);
                        setIsLoggedIn(true);
                        setUserRole(data.user.role);
                        setCurrentUser(data.user);
                        showMessage('登入成功！', 'success');
                        loadPreferences().then(() => loadMaterials());
                    } else {
                        showMessage(data.message || '登入失敗', 'error');
                    }
                } catch (error) {
                    showMessage('登入錯誤: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Logout
            const handleLogout = () => {
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_role');
                localStorage.removeItem('drafts');
                localStorage.removeItem('socialPostDrafts');
                setIsLoggedIn(false);
                setUserRole(null);
                setCurrentUser(null);
                setTopics([]);
                setDrafts([]);
                setSocialPostDrafts([]);
                showMessage('已成功登出', 'success');
            };

            // Fetch news
            const handleFetchNews = async () => {
                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/news/fetch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ timeframe })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        showMessage(`已獲取 ${data.data.count} 則新聞`, 'success');
                        // Auto-process after fetching
                        setTimeout(() => handleProcessNews(), 1000);
                    } else {
                        showMessage(data.message || '獲取新聞失敗', 'error');
                    }
                } catch (error) {
                    showMessage('獲取錯誤: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Process news into topics
            const handleProcessNews = async () => {
                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/news/process', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ timeframe })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        showMessage(`已建立 ${data.data.topics.length} 個主題`, 'success');
                        if (categories.length > 0) {
                            loadAllTopics(categories);
                        }
                    } else {
                        showMessage(data.message || '處理新聞失敗', 'error');
                    }
                } catch (error) {
                    showMessage('處理錯誤: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Load topics for all categories
            const loadAllTopics = async (cats) => {
                const token = localStorage.getItem('jwt_token');
                const topicsMap = {};
                const loadingMap = {};

                // Initialize loading states
                cats.forEach(cat => {
                    const catName = typeof cat === 'object' ? cat.name : cat;
                    loadingMap[catName] = true;
                });
                setLoadingTopics(loadingMap);

                // Load topics for each category
                const promises = cats.map(async (cat) => {
                    const catName = typeof cat === 'object' ? cat.name : cat;
                    try {
                        const res = await fetch(`/api/topics?category=${encodeURIComponent(catName)}&limit=20`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (res.ok) {
                            const data = await res.json();
                            topicsMap[catName] = (data.data || []).sort((a, b) => 
                                (b.finalScore || b.discussionScore || 0) - (a.finalScore || a.discussionScore || 0)
                            ).slice(0, 5);
                        }
                    } catch (error) {
                        console.error(`Failed to load topics for ${catName}:`, error);
                        topicsMap[catName] = [];
                    } finally {
                        loadingMap[catName] = false;
                    }
                });

                await Promise.all(promises);
                setTopicsByCategory(topicsMap);
                setLoadingTopics(loadingMap);
            };

            // Submit feedback
            const handleFeedback = async (topicId, feedback) => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/topics/${topicId}/feedback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ feedback })
                    });

                    if (res.ok) {
                        // Update local feedback state without reloading
                        setTopicFeedback(prev => ({
                            ...prev,
                            [topicId]: feedback
                        }));
                        showMessage('已記錄回饋！', 'success');
                    }
                } catch (error) {
                    showMessage('回饋錯誤: ' + error.message, 'error');
                }
            };

            // Refresh topics (reload all topics)
            const handleRefreshTopics = async () => {
                if (categories.length > 0) {
                    // Reload user info to get latest feedback
                    await loadUserInfo();
                    // Then reload topics
                    loadAllTopics(categories);
                    showMessage('已重新載入主題', 'success');
                }
            };

            // Add topic to draft (persisted to DB)
            const handleAddToDraft = async (topic) => {
                const exists = drafts.some(d => d._id === topic._id);
                if (exists) {
                    showMessage('此主題已在素材夾中', 'info');
                    return;
                }
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    showMessage('請先登入', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/materials/topics', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topicId: topic._id })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setDrafts(prev => [...prev, topic]);
                        showMessage('已加入素材夾', 'success');
                    } else {
                        showMessage(data.message || '加入失敗', 'error');
                    }
                } catch (e) {
                    showMessage('加入失敗: ' + e.message, 'error');
                }
            };

            // Remove topic from draft (persisted to DB)
            const handleRemoveFromDraft = async (topicId) => {
                const token = localStorage.getItem('jwt_token');
                if (!token) return;
                try {
                    const res = await fetch(`/api/materials/topics/${topicId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        setDrafts(prev => prev.filter(d => d._id !== topicId));
                        showMessage('已從素材夾移除', 'success');
                    }
                } catch (e) {
                    showMessage('移除失敗: ' + e.message, 'error');
                }
            };

            // Remove social post from draft (persisted to DB)
            const handleRemoveSocialPostFromDraft = async (postId) => {
                const token = localStorage.getItem('jwt_token');
                if (!token) return;
                const postToRemove = socialPostDrafts.find(p =>
                    p._id === postId || (typeof postId === 'string' && p.externalId === postId)
                );
                const idToDelete = postToRemove?._id || postId;
                if (!idToDelete) return;
                try {
                    const res = await fetch(`/api/materials/social-posts/${idToDelete}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const idStr = (idToDelete && (idToDelete.toString && idToDelete.toString())) || idToDelete;
                        setSocialPostDrafts(prev => prev.filter(d => (d._id && d._id.toString()) !== idStr));
                        showMessage('已從素材夾移除', 'success');
                    }
                } catch (e) {
                    showMessage('移除失敗: ' + e.message, 'error');
                }
            };

            // Show message
            const showMessage = (text, type = 'info') => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 5000);
            };

            const handleStartArticleFromTopic = async (topic) => {
                if (!topic || !topic._id) {
                    showMessage('請選擇主題', 'error');
                    return;
                }
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    showMessage('請先登入', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/writer/generate', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topicId: topic._id, options: { language: 'zh-TW' } })
                    });
                    const data = await res.json();
                    if (res.status === 201 && data.jobId) {
                        setPendingWriterJobId(data.jobId);
                        setCurrentRoute('writer');
                        showMessage('已開始生成文章，請在寫作中心查看', 'info');
                    } else {
                        showMessage(data.message || '發起失敗', 'error');
                    }
                } catch (e) {
                    showMessage('請求錯誤: ' + e.message, 'error');
                }
            };

            const handleStartArticleFromSocialPost = async (post) => {
                if (!post || !post._id) {
                    showMessage('請選擇貼文', 'error');
                    return;
                }
                const token = localStorage.getItem('jwt_token');
                if (!token) {
                    showMessage('請先登入', 'error');
                    return;
                }
                try {
                    const res = await fetch('/api/writer/generate', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ socialPostId: post._id, options: { language: 'zh-TW' } })
                    });
                    const data = await res.json();
                    if (res.status === 201 && data.jobId) {
                        setPendingWriterJobId(data.jobId);
                        setCurrentRoute('writer');
                        showMessage('已開始生成文章，請在寫作中心查看', 'info');
                    } else {
                        showMessage(data.message || '發起失敗', 'error');
                    }
                } catch (e) {
                    showMessage('請求錯誤: ' + e.message, 'error');
                }
            };

            // Load last auto-fetch time
            const loadLastAutoFetchTime = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/social-fetch-schedule', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setLastAutoFetchTime(data.data?.lastRunAt || null);
                    }
                } catch (error) {
                    console.error('Failed to load last auto-fetch time:', error);
                }
            };

            // Load social handles and feeds
            const loadSocialHandles = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/social/handles', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setSocialHandles(data.data || []);
                        // Load feeds for each handle
                        if (data.data && data.data.length > 0) {
                            loadSocialFeeds(data.data);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load social handles:', error);
                }
            };

            // Load feeds for all handles
            const loadSocialFeeds = async (handles) => {
                setLoadingSocial(true);
                const feedsMap = {};
                const token = localStorage.getItem('jwt_token');
                
                for (const handle of handles) {
                    try {
                        const res = await fetch(`/api/social/feed?handleId=${handle._id}&sort=publishedAt&limit=100`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const posts = data.data.posts || [];
                            console.log(`[${handle.handle}] Loaded posts from API:`, {
                                count: posts.length,
                                platform: handle.platform,
                                postIds: posts.map(p => p.externalId || p._id).slice(0, 5),
                                samplePost: posts.length > 0 ? {
                                    externalId: posts[0].externalId,
                                    platform: posts[0].platform,
                                    publishedAt: posts[0].publishedAt,
                                    updatedAt: posts[0].updatedAt,
                                    hasContent: !!posts[0].content
                                } : null
                            });
                            feedsMap[handle._id] = {
                                handle: handle,
                                posts: posts,
                                sort: 'publishedAt'
                            };
                        }
                    } catch (error) {
                        console.error(`Failed to load feed for ${handle.handle}:`, error);
                        feedsMap[handle._id] = {
                            handle: handle,
                            posts: [],
                            sort: 'publishedAt'
                        };
                    }
                }
                
                setSocialFeeds(feedsMap);
                setLoadingSocial(false);
            };

            // Refresh social feeds
            const handleRefreshSocialFeeds = async () => {
                setLoadingSocial(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/social/fetch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (res.ok) {
                        showMessage('已重新載入社交媒體動態', 'success');
                        // Reload feeds
                        await loadSocialHandles();
                    } else {
                        showMessage('重新載入失敗', 'error');
                    }
                } catch (error) {
                    showMessage('重新載入錯誤: ' + error.message, 'error');
                } finally {
                    setLoadingSocial(false);
                }
            };

            // Change sort for a handle
            const handleChangeSort = async (handleId, sort) => {
                const handle = socialHandles.find(h => h._id === handleId);
                if (!handle) return;
                
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/social/feed?handleId=${handleId}&sort=${sort}&limit=100`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setSocialFeeds(prev => ({
                            ...prev,
                            [handleId]: {
                                handle: handle,
                                posts: data.data.posts || [],
                                sort: sort
                            }
                        }));
                    }
                } catch (error) {
                    console.error(`Failed to change sort for ${handle.handle}:`, error);
                }
            };

            // Load topics when categories are loaded
            useEffect(() => {
                if (isLoggedIn && categories.length > 0) {
                    loadAllTopics(categories);
                }
            }, [isLoggedIn]);

            // Load social handles and last auto-fetch time when logged in
            useEffect(() => {
                if (isLoggedIn) {
                    loadSocialHandles();
                    loadLastAutoFetchTime();
                }
            }, [isLoggedIn]);

            if (!isLoggedIn) {
                return <LoginPage onLogin={handleLogin} loading={loading} message={message} />;
            }

            // Show admin panel for ADMIN role
            if (userRole === 'ADMIN' && showAdminPanel) {
                return (
                    <div className="app">
                        <Header 
                            onLogout={handleLogout} 
                            onPreferences={() => setShowPreferences(true)}
                            onAdminPanel={() => setShowAdminPanel(false)}
                            userRole={userRole}
                            currentUser={currentUser}
                            currentRoute={currentRoute}
                            onRouteChange={setCurrentRoute}
                        />
                        {message && (
                            <div className={`message message-${message.type}`}>
                                {message.text}
                            </div>
                        )}
                        <AdminPanel 
                            onBack={() => setShowAdminPanel(false)}
                            showMessage={showMessage}
                        />
                    </div>
                );
            }

            // Render content based on current route
            let mainContent;
            if (currentRoute === 'draft') {
                mainContent = (
                    <DraftPage
                        drafts={drafts}
                        socialPostDrafts={socialPostDrafts}
                        onRemoveFromDraft={handleRemoveFromDraft}
                        onRemoveSocialPostFromDraft={handleRemoveSocialPostFromDraft}
                        onGenerateArticle={handleStartArticleFromTopic}
                        onGenerateArticleFromSocialPost={handleStartArticleFromSocialPost}
                        topicFeedback={topicFeedback}
                        onFeedback={handleFeedback}
                    />
                );
            } else if (currentRoute === 'writer') {
                mainContent = (
                    <WriterCentralPage
                        showMessage={showMessage}
                        isActive={true}
                        pendingWriterJobId={pendingWriterJobId}
                        onConsumeJobId={() => setPendingWriterJobId(null)}
                    />
                );
            } else if (currentRoute === 'social') {
                mainContent = (
                    <SocialTopicDiscovery
                        handles={socialHandles}
                        feeds={socialFeeds}
                        loading={loadingSocial}
                        onRefresh={handleRefreshSocialFeeds}
                        timeframe={socialTimeframe}
                        onTimeframeChange={setSocialTimeframe}
                        sort={socialSort}
                        onSortChange={setSocialSort}
                        onAddToDraft={handleAddSocialPostToDraft}
                        drafts={socialPostDrafts}
                        lastAutoFetchTime={lastAutoFetchTime}
                    />
                );
            } else {
                // Default: Topic Discovery
                mainContent = (
                    <>
                        <ControlPanel
                            timeframe={timeframe}
                            onTimeframeChange={setTimeframe}
                            onFetchNews={handleFetchNews}
                            onProcessNews={handleProcessNews}
                            onRefreshTopics={handleRefreshTopics}
                            loading={loading}
                        />

                        <CategoriesSection
                            categories={categories}
                            topicsByCategory={topicsByCategory}
                            loadingTopics={loadingTopics}
                            topicFeedback={topicFeedback}
                            onFeedback={handleFeedback}
                            onAddToDraft={handleAddToDraft}
                            drafts={drafts}
                        />
                    </>
                );
            }

            // Show regular dashboard for all users
            return (
                <div className="app">
                    <Header 
                        onLogout={handleLogout} 
                        onPreferences={() => setShowPreferences(true)}
                        onAdminPanel={() => setShowAdminPanel(true)}
                        userRole={userRole}
                        currentUser={currentUser}
                        currentRoute={currentRoute}
                        onRouteChange={setCurrentRoute}
                    />
                    
                    {message && (
                        <div className={`message message-${message.type}`}>
                            {message.text}
                        </div>
                    )}

                    <div className="main-content">
                        {mainContent}
                    </div>

                    {showPreferences && (
                        <PreferencesModal
                            preferences={preferences}
                            userRole={userRole}
                            onClose={() => setShowPreferences(false)}
                            onSave={async (newPrefs) => {
                                setPreferences(newPrefs);
                                setCategories(newPrefs.categories || []);
                                setTimeframe(newPrefs.defaultTimeframe || '24h');
                                setShowPreferences(false);
                                showMessage('偏好設定已儲存！', 'success');
                            }}
                        />
                    )}
                </div>
            );
        }

        function LoginPage({ onLogin, loading, message }) {
            return (
                <div className="login-container">
                    <h2>News AI</h2>
                    <p style={{ textAlign: 'center', color: 'var(--text-light)', marginBottom: '1.5rem' }}>
                        AI 驅動的新聞聚合平台
                    </p>
                    {message && (
                        <div className={`message message-${message.type}`}>
                            {message.text}
                        </div>
                    )}
                    <form onSubmit={onLogin}>
                        <div className="form-group">
                            <label htmlFor="username">使用者名稱</label>
                            <input
                                type="text"
                                id="username"
                                name="username"
                                className="form-control"
                                required
                                disabled={loading}
                                autoComplete="username"
                            />
                        </div>
                        <div className="form-group">
                            <label htmlFor="password">密碼</label>
                            <input
                                type="password"
                                id="password"
                                name="password"
                                className="form-control"
                                required
                                disabled={loading}
                                autoComplete="current-password"
                            />
                        </div>
                        <button type="submit" className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>
                            {loading ? '登入中...' : '登入'}
                        </button>
                    </form>
                </div>
            );
        }

        function Header({ onLogout, onPreferences, onAdminPanel, userRole, currentUser, currentRoute, onRouteChange }) {
            return (
                <div className="header">
                    <div style={{ display: 'flex', alignItems: 'center', gap: '2rem' }}>
                        <h1>📰 LiteNews AI</h1>
                        <nav style={{ display: 'flex', gap: '1rem' }}>
                            <button
                                className={`btn ${currentRoute === 'discovery' ? 'btn-primary' : 'btn-outline'} btn-sm`}
                                onClick={() => onRouteChange('discovery')}
                            >
                                主題發現
                            </button>
                            <button
                                className={`btn ${currentRoute === 'social' ? 'btn-primary' : 'btn-outline'} btn-sm`}
                                onClick={() => onRouteChange('social')}
                            >
                                社交主題
                            </button>
                            <button
                                className={`btn ${currentRoute === 'draft' ? 'btn-primary' : 'btn-outline'} btn-sm`}
                                onClick={() => onRouteChange('draft')}
                            >
                                素材夾
                            </button>
                            <button
                                className={`btn ${currentRoute === 'writer' ? 'btn-primary' : 'btn-outline'} btn-sm`}
                                onClick={() => onRouteChange('writer')}
                            >
                                寫作中心
                            </button>
                        </nav>
                    </div>
                    <div className="header-actions">
                        {currentUser && (
                            <span style={{ marginRight: '1rem', color: 'var(--text-light)' }}>
                                {currentUser.name} ({userRole === 'ADMIN' ? '管理員' : '使用者'})
                            </span>
                        )}
                        {userRole === 'ADMIN' && (
                            <button className="btn btn-outline btn-sm" onClick={onAdminPanel}>
                                👤 管理面板
                            </button>
                        )}
                        <button className="btn btn-outline btn-sm" onClick={onPreferences}>
                            ⚙️ 偏好設定
                        </button>
                        <button className="btn btn-secondary btn-sm" onClick={onLogout}>
                            登出
                        </button>
                    </div>
                </div>
            );
        }

        function ControlPanel({ timeframe, onTimeframeChange, onFetchNews, onProcessNews, onRefreshTopics, loading }) {
            return (
                <div className="control-panel">
                    <div className="control-group">
                        <label>時間範圍：</label>
                        <select
                            className="select"
                            value={timeframe}
                            onChange={(e) => onTimeframeChange(e.target.value)}
                            disabled={loading}
                        >
                            <option value="24h">過去 24 小時</option>
                            <option value="7d">過去 7 天</option>
                            <option value="30d">過去 30 天</option>
                        </select>
                    </div>
                    <div className="control-group">
                        <button
                            className="btn btn-primary"
                            onClick={onFetchNews}
                            disabled={loading}
                        >
                            📥 獲取新聞
                        </button>
                        <button
                            className="btn btn-success"
                            onClick={onProcessNews}
                            disabled={loading}
                        >
                            🤖 處理主題
                        </button>
                        <button
                            className="btn btn-outline"
                            onClick={onRefreshTopics}
                            disabled={loading}
                        >
                            🔄 重新整理
                        </button>
                    </div>
                </div>
            );
        }

        function CategoriesSection({ categories, topicsByCategory, loadingTopics, topicFeedback, onFeedback, onAddToDraft, drafts }) {
            // Helper to get category display name
            const getCatDisplay = (catName) => {
                if (!categories) return catName;
                const found = categories.find(c => 
                    (typeof c === 'object' ? c.name : c) === catName
                );
                return found ? (typeof found === 'object' ? found.displayName : found) : catName;
            };

            if (!categories || categories.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">📰</div>
                        <h3>沒有分類</h3>
                        <p>請先在偏好設定中設定分類</p>
                    </div>
                );
            }

            return (
                <div className="categories-section">
                    {categories.map(cat => {
                        const catName = typeof cat === 'object' ? cat.name : cat;
                        const topics = topicsByCategory[catName] || [];
                        const isLoading = loadingTopics[catName];
                        return (
                            <CategoryCard
                                key={catName}
                                categoryName={catName}
                                categoryDisplay={getCatDisplay(catName)}
                                topics={topics}
                                loading={isLoading}
                                topicFeedback={topicFeedback}
                                onFeedback={onFeedback}
                                onAddToDraft={onAddToDraft}
                                drafts={drafts}
                            />
                        );
                    })}
                </div>
            );
        }

        function SocialTopicDiscovery({ handles, feeds, loading, onRefresh, timeframe, onTimeframeChange, sort, onSortChange, onAddToDraft, drafts, lastAutoFetchTime }) {
            if (!handles || handles.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">📱</div>
                        <h3>沒有社交媒體帳號</h3>
                        <p>請先在偏好設定中設定社交媒體帳號</p>
                    </div>
                );
            }

            return (
                <>
                    {/* ControlPanel with timeframe filter, sort options, and refresh button */}
                    <div className="control-panel">
                        <div className="control-group">
                            <label>時間範圍：</label>
                            <select
                                className="select"
                                value={timeframe}
                                onChange={(e) => onTimeframeChange(e.target.value)}
                                disabled={loading}
                            >
                                <option value="24h">過去 24 小時</option>
                                <option value="2d">過去 2 天</option>
                                <option value="5d">過去 5 天</option>
                                <option value="7d">過去 7 天</option>
                            </select>
                        </div>
                        <div className="control-group">
                            <label>排序方式：</label>
                            <button
                                className={`btn btn-sm ${sort === 'publishedAt' ? 'btn-primary' : 'btn-outline'}`}
                                onClick={() => onSortChange('publishedAt')}
                                disabled={loading}
                            >
                                首發時間
                            </button>
                            <button
                                className={`btn btn-sm ${sort === 'popularity' ? 'btn-primary' : 'btn-outline'}`}
                                onClick={() => onSortChange('popularity')}
                                disabled={loading}
                            >
                                熱門
                            </button>
                        </div>
                        <div className="control-group">
                            <button
                                className="btn btn-outline"
                                onClick={onRefresh}
                                disabled={loading}
                            >
                                {loading ? '載入中...' : '刷新貼文'}
                            </button>
                        </div>
                        {lastAutoFetchTime && (
                            <div className="control-group" style={{ fontSize: '0.875rem', color: 'var(--text-light)', display: 'flex', alignItems: 'center' }}>
                                <span>最後自動獲取：</span>
                                <span style={{ marginLeft: '0.5rem' }}>{new Date(lastAutoFetchTime).toLocaleString('zh-TW')}</span>
                            </div>
                        )}
                    </div>
                    <div className="social-feed-grid">
                        {handles.map(handle => (
                            <SocialMediaHandleCard
                                key={handle._id}
                                handle={handle}
                                feed={feeds[handle._id]}
                                timeframe={timeframe}
                                sort={sort}
                                onAddToDraft={onAddToDraft}
                                drafts={drafts}
                            />
                        ))}
                    </div>
                </>
            );
        }

        function CategoryCard({ categoryName, categoryDisplay, topics, loading, topicFeedback, onFeedback, onAddToDraft, drafts }) {
            return (
                <div className="category-card">
                    <h2 className="category-title">{categoryDisplay}</h2>
                    <div className="category-content">
                        {loading ? (
                            <div className="loading" style={{ padding: '1rem' }}>
                                <div className="spinner"></div>
                                <p style={{ fontSize: '0.75rem' }}>載入主題中...</p>
                            </div>
                        ) : topics.length === 0 ? (
                            <div className="empty-topics">暫無主題</div>
                        ) : (
                            <div className="topics-list">
                                {topics.map(topic => (
                                    <TopicRow
                                        key={topic._id}
                                        topic={topic}
                                        feedback={topicFeedback[topic._id?.toString() || topic._id]}
                                        onFeedback={onFeedback}
                                        onAddToDraft={onAddToDraft}
                                        drafts={drafts}
                                    />
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function TopicRow({ topic, feedback, onFeedback, onAddToDraft, drafts }) {
            const [showModal, setShowModal] = useState(false);

            const handleAddToDraft = (e) => {
                e.stopPropagation();
                if (onAddToDraft) {
                    onAddToDraft(topic);
                }
            };

            // Check if topic is already in drafts
            const isInDraft = drafts && drafts.some(d => d._id === topic._id);

            return (
                <>
                    <div className="topic-row" onClick={() => setShowModal(true)}>
                        <div className="topic-row-first">
                            <div className="topic-row-name">{topic.title}</div>
                        </div>
                        <div className="topic-row-second">
                            <div className="topic-row-tags">
                                {topic.tags && topic.tags.slice(0, 5).map((tag, idx) => (
                                    <span key={idx} className="topic-tag-small">{tag}</span>
                                ))}
                            </div>
                            <div className="topic-row-actions" onClick={(e) => e.stopPropagation()}>
                                <button
                                    className={`btn-icon btn-icon-small ${feedback === 'up' ? 'btn-feedback-active btn-feedback-up' : ''}`}
                                    onClick={() => onFeedback(topic._id, 'up')}
                                    title="喜歡"
                                >
                                    👍
                                </button>
                                <button
                                    className={`btn-icon btn-icon-small ${feedback === 'down' ? 'btn-feedback-active btn-feedback-down' : ''}`}
                                    onClick={() => onFeedback(topic._id, 'down')}
                                    title="不喜歡"
                                >
                                    👎
                                </button>
                                <button
                                    className={`btn btn-sm ${isInDraft ? 'btn-primary' : 'btn-outline'}`}
                                    onClick={handleAddToDraft}
                                    title={isInDraft ? '已在素材夾' : '加進素材'}
                                    style={{ fontSize: '0.7rem', padding: '0.2rem 0.4rem' }}
                                >
                                    {isInDraft ? '已在素材' : '加進素材'}
                                </button>
                            </div>
                        </div>
                    </div>
                    {showModal && (
                        <TopicModal
                            topic={topic}
                            onClose={() => setShowModal(false)}
                        />
                    )}
                </>
            );
        }

        function TopicModal({ topic, onClose }) {
            const [newsItems, setNewsItems] = useState([]);
            const [loadingItems, setLoadingItems] = useState(false);

            useEffect(() => {
                const loadNewsItems = async () => {
                    setLoadingItems(true);
                    try {
                        const token = localStorage.getItem('jwt_token');
                        const res = await fetch('/api/news/items?category=' + encodeURIComponent(topic.category), {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const items = data.data.filter(item => 
                                item.topicId === topic._id || topic.newsItems.includes(item._id)
                            );
                            setNewsItems(items);
                        }
                    } catch (error) {
                        console.error('Failed to load news items:', error);
                    } finally {
                        setLoadingItems(false);
                    }
                };

                loadNewsItems();
            }, [topic]);

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{topic.title}</h3>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        <div className="modal-body">
                            {topic.summary && (
                                <div className="modal-summary">
                                    <strong>摘要：</strong>
                                    <p>{topic.summary}</p>
                                </div>
                            )}
                            <div className="modal-news">
                                <strong>相關新聞：</strong>
                                {loadingItems ? (
                                    <div className="loading" style={{ padding: '1rem' }}>
                                        <div className="spinner"></div>
                                    </div>
                                ) : newsItems.length === 0 ? (
                                    <p style={{ color: 'var(--text-light)' }}>暫無相關新聞</p>
                                ) : (
                                    <ul className="news-links">
                                        {newsItems.map(item => (
                                            <li key={item._id}>
                                                <a href={item.url} target="_blank" rel="noopener noreferrer">
                                                    {item.title}
                                                </a>
                                                {item.description && (
                                                    <span className="news-link-desc">{item.description.substring(0, 100)}...</span>
                                                )}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                            <div className="modal-score">
                                <strong>分數：</strong>
                                <span>{Math.round(topic.finalScore || topic.discussionScore || 0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function SocialSection({ handles, feeds, loading, onRefresh, onChangeSort }) {
            if (!handles || handles.length === 0) {
                return null;
            }

            return (
                <div className="social-section" style={{ marginTop: '2rem' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '0' }}>
                            社交媒體動態
                        </h2>
                        <button
                            className="btn btn-outline btn-sm"
                            onClick={onRefresh}
                            disabled={loading}
                        >
                            {loading ? '載入中...' : '重新載入'}
                        </button>
                    </div>
                    <div className="social-handles-grid">
                        {handles.map(handle => (
                            <SocialMediaHandleCard
                                key={handle._id}
                                handle={handle}
                                feed={feeds[handle._id]}
                                onChangeSort={onChangeSort}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        function SocialMediaHandleCard({ handle, feed, timeframe = '24h', sort = 'publishedAt', onAddToDraft, drafts }) {
            const allPosts = feed?.posts || [];
            const platformBadge = handle.platform === 'x' ? '𝕏' : 
                                   handle.platform === 'instagram' ? '📷' : 
                                   handle.platform === 'threads' ? '🧵' : 
                                   handle.platform === 'facebook' ? '📘' : 
                                   handle.platform === 'youtube' ? '▶️' : '';

            // Parse timeframe and calculate cutoff date
            const getTimeframeCutoff = (timeframe) => {
                const now = new Date();
                const cutoff = new Date(now);
                
                switch (timeframe) {
                    case '24h':
                        cutoff.setHours(now.getHours() - 24);
                        break;
                    case '2d':
                        cutoff.setDate(now.getDate() - 2);
                        break;
                    case '5d':
                        cutoff.setDate(now.getDate() - 5);
                        break;
                    case '7d':
                        cutoff.setDate(now.getDate() - 7);
                        break;
                    default:
                        cutoff.setHours(now.getHours() - 24);
                }
                
                return cutoff;
            };

            // Filter posts by timeframe - only use publishedAt/createdAt
            const cutoffDate = getTimeframeCutoff(timeframe || '24h');
            console.log(`[${handle.handle}] Filtering posts:`, {
                totalPosts: allPosts.length,
                timeframe: timeframe,
                cutoffDate: cutoffDate.toISOString(),
                platform: handle.platform,
                samplePost: allPosts.length > 0 ? {
                    externalId: allPosts[0].externalId,
                    platform: allPosts[0].platform,
                    publishedAt: allPosts[0].publishedAt,
                    updatedAt: allPosts[0].updatedAt
                } : null
            });
            
            const filteredPosts = allPosts.filter(post => {
                // Check publishedAt or createdAt only
                let publishedAtDate = null;
                if (post.publishedAt) {
                    publishedAtDate = new Date(post.publishedAt);
                    if (isNaN(publishedAtDate.getTime())) {
                        publishedAtDate = null;
                    }
                } else if (post.createdAt) {
                    publishedAtDate = new Date(post.createdAt);
                    if (isNaN(publishedAtDate.getTime())) {
                        publishedAtDate = null;
                    }
                }
                
                // If publishedAt/createdAt doesn't exist, exclude the post
                if (!publishedAtDate) {
                    console.warn(`[${handle.handle}] Post missing publishedAt/createdAt:`, {
                        externalId: post.externalId,
                        platform: post.platform,
                        hasPublishedAt: !!post.publishedAt,
                        hasCreatedAt: !!post.createdAt,
                        publishedAtValue: post.publishedAt
                    });
                    return false;
                }
                
                // Include post if publishedAt/createdAt is within timeframe
                const isWithinTimeframe = publishedAtDate >= cutoffDate;
                
                if (!isWithinTimeframe) {
                    console.debug(`[${handle.handle}] Post filtered out (publishedAt older than ${timeframe}):`, {
                        publishedAt: publishedAtDate ? publishedAtDate.toISOString() : 'N/A',
                        cutoffDate: cutoffDate.toISOString(),
                        externalId: post.externalId,
                        platform: post.platform
                    });
                }
                
                return isWithinTimeframe;
            });

            console.log(`[${handle.handle}] After filtering:`, {
                filteredCount: filteredPosts.length,
                platform: handle.platform,
                filteredOut: allPosts.length - filteredPosts.length,
                sampleFilteredPost: filteredPosts.length > 0 ? {
                    externalId: filteredPosts[0].externalId,
                    publishedAt: filteredPosts[0].publishedAt,
                    updatedAt: filteredPosts[0].updatedAt
                } : null
            });

            // Apply sort and limit
            const sortedPosts = [...filteredPosts].sort((a, b) => {
                if (sort === 'publishedAt') {
                    // Sort by publishedAt (首發時間) - newest first
                    const dateA = a.publishedAt ? new Date(a.publishedAt).getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                    const dateB = b.publishedAt ? new Date(b.publishedAt).getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                    return dateB - dateA; // Descending order (newest first)
                } else if (sort === 'popularity') {
                    // Sort by engagement score (popularity)
                    const scoreA = a.engagement?.score ?? 0;
                    const scoreB = b.engagement?.score ?? 0;
                    // If scores are equal, use publishedAt as tiebreaker
                    if (scoreA === scoreB) {
                        const dateA = a.publishedAt ? new Date(a.publishedAt).getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                        const dateB = b.publishedAt ? new Date(b.publishedAt).getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                        return dateB - dateA; // Newer first as tiebreaker
                    }
                    return scoreB - scoreA;
                } else {
                    // Default to publishedAt if sort is not recognized
                    const dateA = a.publishedAt ? new Date(a.publishedAt).getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                    const dateB = b.publishedAt ? new Date(b.publishedAt).getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                    return dateB - dateA;
                }
            });
            
            const posts = sortedPosts.slice(0, 5); // Limit to 5 posts
            
            console.log(`[${handle.handle}] Final posts to display:`, {
                count: posts.length,
                sort: sort,
                platform: handle.platform,
                postIds: posts.map(p => p.externalId),
                scores: posts.map(p => ({ id: p.externalId, score: p.engagement?.score ?? 0 }))
            });

            return (
                <div className="social-feed-card">
                    <div className="social-feed-header">
                        <div className="social-feed-handle">
                            <span style={{ fontSize: '1.2rem' }}>{platformBadge}</span>
                            <div className="social-feed-handle-info">
                                <div className="social-feed-handle-name">
                                    {handle.displayName}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="social-posts-list">
                        {posts.length === 0 ? (
                            <div style={{ textAlign: 'center', padding: '1rem', color: 'var(--text-light)', fontSize: '0.75rem' }}>
                                暫無動態
                            </div>
                        ) : (
                            posts.map(post => (
                                <SocialPostRow 
                                    key={post._id || post.externalId} 
                                    post={post}
                                    onAddToDraft={onAddToDraft}
                                    drafts={drafts}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        }

        function SocialPostRow({ post, onAddToDraft, drafts }) {
            const [showModal, setShowModal] = useState(false);
            
            // Check if post is already in drafts
            const isInDraft = drafts && drafts.some(d => 
                d._id === post._id || 
                (d.externalId === post.externalId && d.platform === post.platform)
            );

            const handleAddToDraft = (e) => {
                e.stopPropagation();
                if (onAddToDraft) {
                    onAddToDraft(post);
                }
            };
            
            const formatDate = (date) => {
                const d = new Date(date);
                const now = new Date();
                const diffMs = now - d;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return '剛剛';
                if (diffMins < 60) return `${diffMins} 分鐘前`;
                if (diffHours < 24) return `${diffHours} 小時前`;
                if (diffDays < 7) return `${diffDays} 天前`;
                return d.toLocaleDateString('zh-TW');
            };

            // Format number for display
            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            // Prioritize title over content
            const displayText = post.title && post.title.trim() 
                ? (post.title.length > 150 ? post.title.substring(0, 150) + '...' : post.title)
                : (post.content ? (post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content) : '');

            // Determine engagement metrics based on platform
            const isYouTube = post.platform === 'youtube';
            const engagement = post.engagement || {};

            return (
                <>
                    <div 
                        className="social-post-row" 
                        onClick={() => setShowModal(true)}
                        style={{ cursor: 'pointer' }}
                    >
                        <div className="social-post-content">
                            {displayText && (
                                <div style={{ fontSize: '0.875rem', color: 'var(--text)', marginBottom: '0.5rem', lineHeight: '1.5' }}>
                                    {displayText}
                                </div>
                            )}
                            <div className="social-post-meta">
                                {/* Display Date - Use publishedAt, fall back to createdAt - Always shown */}
                                <span style={{ fontSize: '0.7rem', color: 'var(--text-light)' }}>
                                    {formatDate(post.publishedAt || post.createdAt)}
                                </span>
                                
                                {/* Engagement Metrics - Always shown, consistent layout */}
                                <div style={{ display: 'flex', gap: '0.75rem', fontSize: '0.7rem', color: 'var(--text-light)' }}>
                                    {isYouTube ? (
                                        <>
                                            <span>👁️ {formatNumber(engagement.views || 0)}</span>
                                            <span>💬 {formatNumber(engagement.comments || 0)}</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>👍 {formatNumber(engagement.likes || 0)}</span>
                                            <span>🔄 {formatNumber(engagement.reposts || 0)}</span>
                                            <span>💬 {formatNumber(engagement.replies || 0)}</span>
                                        </>
                                    )}
                                </div>
                                
                                {/* 加進素材 Button - Always shown */}
                                <button
                                    className={`btn btn-sm ${isInDraft ? 'btn-primary' : 'btn-outline'}`}
                                    onClick={handleAddToDraft}
                                    disabled={isInDraft}
                                    style={{
                                        fontSize: '0.7rem',
                                        padding: '0.3rem 0.6rem',
                                        whiteSpace: 'nowrap'
                                    }}
                                    title={isInDraft ? '已在素材夾' : '加進素材'}
                                >
                                    {isInDraft ? '已在素材' : '加進素材'}
                                </button>
                            </div>
                        </div>
                    </div>
                    {showModal && (
                        <SocialPostModal post={post} onClose={() => setShowModal(false)} />
                    )}
                </>
            );
        }

        function SocialPostModal({ post, onClose }) {
            const [quotedTweetUrl, setQuotedTweetUrl] = useState(null);
            const [tweetPreview, setTweetPreview] = useState(null);
            const [loadingPreview, setLoadingPreview] = useState(false);

            const formatDate = (date) => {
                if (!date) return '未知';
                const d = new Date(date);
                return d.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            // Extract YouTube video ID from URL
            const getYouTubeVideoId = (url) => {
                if (!url) return null;
                const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
                return match ? match[1] : null;
            };

            // Extract X/Twitter tweet URLs from content
            const extractTweetUrls = (text) => {
                if (!text) return [];
                const tweetUrlRegex = /https?:\/\/(?:twitter\.com|x\.com)\/(\w+)\/status\/(\d+)/gi;
                const matches = [];
                let match;
                while ((match = tweetUrlRegex.exec(text)) !== null) {
                    matches.push({
                        fullUrl: match[0],
                        username: match[1],
                        tweetId: match[2]
                    });
                }
                return matches;
            };

            // Fetch tweet preview using oEmbed (if available) or show link preview
            useEffect(() => {
                if (post.platform === 'x' && post.content) {
                    const tweetUrls = extractTweetUrls(post.content);
                    if (tweetUrls.length > 0) {
                        const firstTweet = tweetUrls[0];
                        setQuotedTweetUrl(firstTweet.fullUrl);
                        // Try to fetch oEmbed preview
                        setLoadingPreview(true);
                        fetch(`https://publish.twitter.com/oembed?url=${encodeURIComponent(firstTweet.fullUrl)}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data.html) {
                                    setTweetPreview(data);
                                }
                                setLoadingPreview(false);
                            })
                            .catch(err => {
                                console.log('Could not fetch tweet preview:', err);
                                setLoadingPreview(false);
                            });
                    }
                }
            }, [post]);

            const isYouTube = post.platform === 'youtube';
            const engagement = post.engagement || {};
            const metadata = post.metadata || {};
            const mediaUrls = metadata.mediaUrls || [];
            const youtubeVideoId = isYouTube ? getYouTubeVideoId(post.url) : null;

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '800px' }}>
                        <div className="modal-header">
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                {post.author?.avatarUrl && (
                                    <img 
                                        src={post.author.avatarUrl} 
                                        alt={post.author.displayName || post.author.handle}
                                        style={{
                                            width: '40px',
                                            height: '40px',
                                            borderRadius: '50%',
                                            objectFit: 'cover'
                                        }}
                                    />
                                )}
                                <div>
                                    <div style={{ fontWeight: 600, fontSize: '1rem' }}>
                                        {post.author?.displayName || post.author?.handle || post.handle}
                                    </div>
                                    {post.author?.handle && (
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-light)' }}>
                                            @{post.author.handle}
                                        </div>
                                    )}
                                </div>
                            </div>
                            <button className="modal-close" onClick={onClose}>×</button>
                        </div>
                        
                        <div className="modal-body">
                            {/* Full Content */}
                            {post.title && (
                                <div style={{ marginBottom: '1rem' }}>
                                    <h3 style={{ fontSize: '1.25rem', fontWeight: 700, marginBottom: '0.5rem', lineHeight: '1.4' }}>
                                        {post.title}
                                    </h3>
                                </div>
                            )}
                            
                            {post.content && (
                                <div style={{ 
                                    marginBottom: '1.5rem', 
                                    fontSize: '1rem', 
                                    lineHeight: '1.6',
                                    whiteSpace: 'pre-wrap',
                                    wordBreak: 'break-word'
                                }}>
                                    {post.content}
                                </div>
                            )}

                            {/* YouTube Embedded Video */}
                            {isYouTube && youtubeVideoId && (
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <div style={{ position: 'relative', paddingBottom: '56.25%', height: 0, overflow: 'hidden', borderRadius: '8px' }}>
                                        <iframe
                                            src={`https://www.youtube.com/embed/${youtubeVideoId}`}
                                            style={{
                                                position: 'absolute',
                                                top: 0,
                                                left: 0,
                                                width: '100%',
                                                height: '100%',
                                                border: 'none'
                                            }}
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowFullScreen
                                        />
                                    </div>
                                </div>
                            )}

                            {/* Quoted/Reposted Tweet Preview (X/Twitter) */}
                            {quotedTweetUrl && (() => {
                                const urlMatch = quotedTweetUrl.match(/(?:twitter\.com|x\.com)\/(\w+)\/status\/(\d+)/);
                                const quotedUsername = urlMatch ? urlMatch[1] : null;
                                
                                return (
                                    <div style={{ 
                                        marginBottom: '1.5rem',
                                        border: '1px solid var(--border)',
                                        borderRadius: '12px',
                                        padding: '1rem',
                                        background: 'var(--bg)'
                                    }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            gap: '0.5rem',
                                            marginBottom: '0.75rem',
                                            fontSize: '0.875rem',
                                            color: 'var(--text-light)'
                                        }}>
                                            <span>🔄</span>
                                            <span>轉發的貼文</span>
                                        </div>
                                        {loadingPreview ? (
                                            <div style={{ textAlign: 'center', padding: '1rem' }}>
                                                <div className="spinner" style={{ margin: '0 auto' }}></div>
                                                <p style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginTop: '0.5rem' }}>載入預覽中...</p>
                                            </div>
                                        ) : tweetPreview && tweetPreview.html ? (
                                            <div 
                                                dangerouslySetInnerHTML={{ __html: tweetPreview.html }}
                                                style={{ marginBottom: '0.5rem' }}
                                            />
                                        ) : (
                                            <div style={{ 
                                                padding: '1rem',
                                                background: 'var(--card-bg)',
                                                borderRadius: '8px',
                                                border: '1px solid var(--border)',
                                                transition: 'all 0.2s'
                                            }}>
                                                <div style={{ 
                                                    display: 'flex', 
                                                    alignItems: 'center', 
                                                    gap: '0.75rem',
                                                    marginBottom: '0.75rem'
                                                }}>
                                                    <div style={{
                                                        width: '40px',
                                                        height: '40px',
                                                        borderRadius: '50%',
                                                        background: 'var(--primary)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        color: 'white',
                                                        fontSize: '1.25rem',
                                                        fontWeight: 600
                                                    }}>
                                                        𝕏
                                                    </div>
                                                    <div>
                                                        {quotedUsername && (
                                                            <div style={{ fontWeight: 600, fontSize: '0.875rem' }}>
                                                                @{quotedUsername}
                                                            </div>
                                                        )}
                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-light)' }}>
                                                            在 X (Twitter) 上的貼文
                                                        </div>
                                                    </div>
                                                </div>
                                                <a
                                                    href={quotedTweetUrl}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="btn btn-outline btn-sm"
                                                    style={{ 
                                                        textDecoration: 'none',
                                                        width: '100%',
                                                        textAlign: 'center'
                                                    }}
                                                >
                                                    查看轉發的貼文 →
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                );
                            })()}

                            {/* Media Gallery */}
                            {mediaUrls.length > 0 && !isYouTube && (
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <div style={{ 
                                        display: 'grid', 
                                        gridTemplateColumns: mediaUrls.length === 1 ? '1fr' : 'repeat(2, 1fr)',
                                        gap: '0.5rem'
                                    }}>
                                        {mediaUrls.map((url, idx) => (
                                            <img 
                                                key={idx}
                                                src={url} 
                                                alt={`Media ${idx + 1}`}
                                                style={{
                                                    width: '100%',
                                                    height: 'auto',
                                                    borderRadius: '8px',
                                                    objectFit: 'cover',
                                                    maxHeight: '400px'
                                                }}
                                                onError={(e) => {
                                                    e.target.style.display = 'none';
                                                }}
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Engagement Metrics */}
                            <div style={{ 
                                display: 'flex', 
                                gap: '1.5rem', 
                                padding: '1rem',
                                background: 'var(--bg)',
                                borderRadius: '8px',
                                marginBottom: '1.5rem',
                                flexWrap: 'wrap'
                            }}>
                                {isYouTube ? (
                                    <>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginBottom: '0.25rem' }}>觀看次數</div>
                                            <div style={{ fontSize: '1.25rem', fontWeight: 600 }}>👁️ {formatNumber(engagement.views || 0)}</div>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginBottom: '0.25rem' }}>留言</div>
                                            <div style={{ fontSize: '1.25rem', fontWeight: 600 }}>💬 {formatNumber(engagement.comments || 0)}</div>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginBottom: '0.25rem' }}>讚</div>
                                            <div style={{ fontSize: '1.25rem', fontWeight: 600 }}>👍 {formatNumber(engagement.likes || 0)}</div>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginBottom: '0.25rem' }}>轉發</div>
                                            <div style={{ fontSize: '1.25rem', fontWeight: 600 }}>🔄 {formatNumber(engagement.reposts || 0)}</div>
                                        </div>
                                        <div>
                                            <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginBottom: '0.25rem' }}>回覆</div>
                                            <div style={{ fontSize: '1.25rem', fontWeight: 600 }}>💬 {formatNumber(engagement.replies || 0)}</div>
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* Dates */}
                            <div style={{ 
                                padding: '1rem',
                                background: 'var(--bg)',
                                borderRadius: '8px',
                                marginBottom: '1.5rem',
                                fontSize: '0.875rem',
                                color: 'var(--text-light)'
                            }}>
                                {post.publishedAt && (
                                    <div style={{ marginBottom: '0.5rem' }}>
                                        <strong>首發時間：</strong>{formatDate(post.publishedAt)}
                                    </div>
                                )}
                                {post.updatedAt && post.updatedAt !== post.publishedAt && (
                                    <div>
                                        <strong>更新時間：</strong>{formatDate(post.updatedAt)}
                                    </div>
                                )}
                            </div>

                            {/* Tags */}
                            {metadata.tags && metadata.tags.length > 0 && (
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                        {metadata.tags.map((tag, idx) => (
                                            <span 
                                                key={idx}
                                                style={{
                                                    padding: '0.25rem 0.75rem',
                                                    background: 'var(--bg)',
                                                    borderRadius: '12px',
                                                    fontSize: '0.75rem',
                                                    color: 'var(--primary)'
                                                }}
                                            >
                                                #{tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* External Link */}
                            <div style={{ textAlign: 'center', marginTop: '1.5rem' }}>
                                <a
                                    href={post.url || '#'}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="btn btn-primary"
                                    style={{ textDecoration: 'none' }}
                                >
                                    查看原文 →
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function TopicCard({ topic, categories, onFeedback }) {
            const [expanded, setExpanded] = useState(false);
            const [newsItems, setNewsItems] = useState([]);
            const [loadingItems, setLoadingItems] = useState(false);

            // Helper to get category display name
            const getCatDisplay = (catName) => {
                if (!categories) return catName;
                const found = categories.find(c => 
                    (typeof c === 'object' ? c.name : c) === catName
                );
                return found ? (typeof found === 'object' ? found.displayName : found) : catName;
            };

            const loadNewsItems = async () => {
                if (newsItems.length > 0) {
                    setExpanded(!expanded);
                    return;
                }

                setLoadingItems(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/news/items?category=' + encodeURIComponent(topic.category), {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const items = data.data.filter(item => 
                            item.topicId === topic._id || topic.newsItems.includes(item._id)
                        );
                        setNewsItems(items);
                        setExpanded(true);
                    }
                } catch (error) {
                    console.error('Failed to load news items:', error);
                } finally {
                    setLoadingItems(false);
                }
            };

            return (
                <div className="topic-card">
                    <div className="topic-header">
                        <div style={{ flex: 1 }}>
                            <span className="topic-category">{getCatDisplay(topic.category)}</span>
                            <h3 className="topic-title">{topic.title}</h3>
                        </div>
                    </div>
                    {topic.summary && (
                        <p className="topic-summary">{topic.summary}</p>
                    )}
                    {topic.tags && topic.tags.length > 0 && (
                        <div className="topic-tags" style={{ marginBottom: '1rem', display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                            {topic.tags.slice(0, 3).map((tag, idx) => (
                                <span key={idx} className="topic-tag">{tag}</span>
                            ))}
                        </div>
                    )}
                    <div className="topic-meta">
                        <span>📊 分數: {Math.round(topic.finalScore || topic.discussionScore || 0)}</span>
                        <span>📰 {topic.newsItems?.length || 0} 則新聞</span>
                    </div>
                    <div className="topic-actions">
                        <button
                            className="btn-icon"
                            onClick={() => onFeedback(topic._id, 'up')}
                            title="喜歡"
                        >
                            👍
                        </button>
                        <button
                            className="btn-icon"
                            onClick={() => onFeedback(topic._id, 'down')}
                            title="不喜歡"
                        >
                            👎
                        </button>
                        <button
                            className="btn btn-outline btn-sm"
                            onClick={loadNewsItems}
                            disabled={loadingItems}
                            style={{ marginLeft: 'auto' }}
                        >
                            {expanded ? '隱藏' : '顯示'}新聞
                        </button>
                    </div>
                    {expanded && (
                        <div className="news-items">
                            {loadingItems ? (
                                <div style={{ textAlign: 'center', padding: '1rem' }}>載入中...</div>
                            ) : newsItems.length > 0 ? (
                                newsItems.map(item => (
                                    <div key={item._id} className="news-item">
                                        <div className="news-item-title">{item.title}</div>
                                        {item.description && (
                                            <div style={{ fontSize: '0.8125rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                                {item.description.substring(0, 100)}...
                                            </div>
                                        )}
                                        <div className="news-item-meta">
                                            <span>{new Date(item.publishedAt).toLocaleDateString('zh-TW')}</span>
                                            <span>{item.source?.name || item.source?.type}</span>
                                            {item.url && (
                                                <a href={item.url} target="_blank" rel="noopener noreferrer" className="news-item-link">
                                                    閱讀更多 →
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div style={{ textAlign: 'center', padding: '1rem', color: 'var(--text-light)' }}>
                                    找不到新聞項目
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function DraftPage({ drafts, socialPostDrafts = [], onRemoveFromDraft, onRemoveSocialPostFromDraft, onGenerateArticle, onGenerateArticleFromSocialPost, topicFeedback, onFeedback }) {
            const [showModal, setShowModal] = useState(false);
            const [selectedTopic, setSelectedTopic] = useState(null);
            const [showSocialPostModal, setShowSocialPostModal] = useState(false);
            const [selectedSocialPost, setSelectedSocialPost] = useState(null);

            const handleTopicClick = (topic) => {
                setSelectedTopic(topic);
                setShowModal(true);
            };

            const handleSocialPostClick = (post) => {
                setSelectedSocialPost(post);
                setShowSocialPostModal(true);
            };

            // Copy topic id to clipboard
            const handleCopyTopicId = async (topicId) => {
                try {
                    await navigator.clipboard.writeText(String(topicId || ''));
                    showMessage('已複製主題 ID', 'success');
                } catch (err) {
                    console.error('copy failed', err);
                    showMessage('複製失敗', 'error');
                }
            };

            // Copy social post id to clipboard (prefer internal _id, fallback to externalId)
            const handleCopySocialFeedId = async (post) => {
                const idToCopy = post?._id || post?.externalId || '';
                try {
                    await navigator.clipboard.writeText(String(idToCopy));
                    showMessage('已複製貼文 ID', 'success');
                } catch (err) {
                    console.error('copy failed', err);
                    showMessage('複製失敗', 'error');
                }
            };

            const totalDrafts = drafts.length + socialPostDrafts.length;

            if (totalDrafts === 0) {
                return (
                    <div className="main-content">
                        <div className="empty-state">
                            <div className="empty-state-icon">📝</div>
                            <h3>素材夾是空的</h3>
                            <p>從「主題發現」或「社交主題」頁面將內容加入素材夾</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="main-content">
                    <div style={{ marginBottom: '2rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '1rem' }}>
                            素材夾 ({totalDrafts})
                        </h2>
                        <p style={{ color: 'var(--text-light)', fontSize: '0.875rem' }}>
                            您已儲存的主題和社交貼文列表，可在此進行進一步操作
                        </p>
                    </div>

                    {/* Topic Drafts */}
                    {drafts.length > 0 && (
                        <div style={{ marginBottom: '2rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: 600, marginBottom: '1rem' }}>
                                主題 ({drafts.length})
                            </h3>
                            <div className="topics-grid">
                                {drafts.map(topic => (
                                    <div key={topic._id} className="topic-card">
                                        <div className="topic-header">
                                            <div style={{ flex: 1 }}>
                                                {topic.category && (
                                                    <span className="topic-category">{topic.category}</span>
                                                )}
                                                <h3 className="topic-title">{topic.title}</h3>
                                            </div>
                                        </div>
                                        {topic.summary && (
                                            <p className="topic-summary">{topic.summary}</p>
                                        )}
                                        {topic.tags && topic.tags.length > 0 && (
                                            <div style={{ marginBottom: '1rem', display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                {topic.tags.slice(0, 5).map((tag, idx) => (
                                                    <span key={idx} className="topic-tag">{tag}</span>
                                                ))}
                                            </div>
                                        )}
                                        <div className="topic-meta">
                                            <span>📊 分數: {Math.round(topic.finalScore || topic.discussionScore || 0)}</span>
                                            <span>📰 {topic.newsItems?.length || 0} 則新聞</span>
                                        </div>
                                        <div className="topic-actions" style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                            <button
                                                className="btn btn-primary btn-sm"
                                                onClick={(e) => { e.stopPropagation(); onGenerateArticle && onGenerateArticle(topic); }}
                                                title="從此主題寫文章"
                                            >
                                                從此主題寫文章
                                            </button>
                                            <button
                                                className="btn btn-outline btn-sm"
                                                onClick={() => handleTopicClick(topic)}
                                            >
                                                查看詳情
                                            </button>
                                            <button
                                                className="btn btn-danger btn-sm"
                                                onClick={() => onRemoveFromDraft(topic._id)}
                                                style={{ flex: '0 0 auto' }}
                                            >
                                                移除
                                            </button>
                                            <button
                                                className="card-copy-btn"
                                                onClick={(e) => { e.stopPropagation(); handleCopyTopicId(topic._id); }}
                                                title="複製主題 ID"
                                                style={{ marginLeft: 'auto' }}
                                            >
                                                複製 ID
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Social Post Drafts - same card layout as topic cards */}
                    {socialPostDrafts.length > 0 && (
                        <div style={{ marginBottom: '2rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: 600, marginBottom: '1rem' }}>
                                社交貼文 ({socialPostDrafts.length})
                            </h3>
                            <div className="topics-grid">
                                {socialPostDrafts.map(post => {
                                    const sourceDisplayName = post.handleId?.displayName || post.author?.displayName || post.handle || '社交貼文';
                                    const platformLabel = post.platform === 'youtube' ? 'YouTube' : post.platform === 'x' ? 'X' : post.platform === 'instagram' ? 'Instagram' : post.platform === 'threads' ? 'Threads' : post.platform === 'facebook' ? 'Facebook' : post.platform || '';
                                    const contentSnippet = (post.title && post.title.trim()) ? (post.title.length > 150 ? post.title.substring(0, 150) + '...' : post.title) : (post.content ? (post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content) : '');
                                    const engagement = post.engagement || {};
                                    const formatNum = (n) => (n >= 1000000 ? (n / 1000000).toFixed(1) + 'M' : n >= 1000 ? (n / 1000).toFixed(1) + 'K' : (n || 0).toString());
                                    const isYouTube = post.platform === 'youtube';
                                    return (
                                        <div key={post._id || post.externalId} className="topic-card">
                                            <div className="topic-header">
                                                <div style={{ flex: 1 }}>
                                                    {platformLabel && (
                                                        <span className="topic-category">{platformLabel}</span>
                                                    )}
                                                    <h3 className="topic-title">{sourceDisplayName}</h3>
                                                </div>
                                            </div>
                                            {contentSnippet && (
                                                <p className="topic-summary" onClick={() => handleSocialPostClick(post)} style={{ cursor: 'pointer' }}>
                                                    {contentSnippet}
                                                </p>
                                            )}
                                            <div className="topic-meta">
                                                <span style={{ fontSize: '0.8125rem', color: 'var(--text-light)' }}>
                                                    {new Date(post.publishedAt || post.updatedAt).toLocaleDateString('zh-TW')}
                                                </span>
                                                <span style={{ fontSize: '0.8125rem', color: 'var(--text-light)' }}>
                                                    {isYouTube ? (
                                                        <>👁️ {formatNum(engagement.views)} · 💬 {formatNum(engagement.comments)}</>
                                                    ) : (
                                                        <>👍 {formatNum(engagement.likes)} · 🔄 {formatNum(engagement.reposts)} · 💬 {formatNum(engagement.replies)}</>
                                                    )}
                                                </span>
                                            </div>
                                            <div className="topic-actions" style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                                <button
                                                    className="btn btn-primary btn-sm"
                                                    onClick={(e) => { e.stopPropagation(); onGenerateArticleFromSocialPost && onGenerateArticleFromSocialPost(post); }}
                                                    title="從此貼文寫文章"
                                                >
                                                    從此主題寫文章
                                                </button>
                                                <button
                                                    className="btn btn-outline btn-sm"
                                                    onClick={() => handleSocialPostClick(post)}
                                                    title="查看貼文詳情"
                                                >
                                                    查看詳情
                                                </button>
                                                <button
                                                    className="btn btn-danger btn-sm"
                                                    onClick={() => onRemoveSocialPostFromDraft(post._id || post.externalId)}
                                                    style={{ flex: '0 0 auto' }}
                                                >
                                                    移除
                                                </button>
                                                <button
                                                    className="card-copy-btn"
                                                    onClick={(e) => { e.stopPropagation(); handleCopySocialFeedId(post); }}
                                                    title="複製貼文 ID"
                                                    style={{ marginLeft: 'auto' }}
                                                >
                                                    複製 ID
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {showModal && selectedTopic && (
                        <TopicModal
                            topic={selectedTopic}
                            onClose={() => {
                                setShowModal(false);
                                setSelectedTopic(null);
                            }}
                        />
                    )}

                    {showSocialPostModal && selectedSocialPost && (
                        <SocialPostModal
                            post={selectedSocialPost}
                            onClose={() => {
                                setShowSocialPostModal(false);
                                setSelectedSocialPost(null);
                            }}
                        />
                    )}
                </div>
            );
        }

        function WriterCentralPage({ showMessage, isActive, pendingWriterJobId, onConsumeJobId }) {
            const [jobId, setJobId] = useState(null);
            const [article, setArticle] = useState(null);
            const [myArticles, setMyArticles] = useState([]);
            const [loadingArticles, setLoadingArticles] = useState(false);
            const token = localStorage.getItem('jwt_token');
            const headers = token ? { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };

            useEffect(() => {
                if (pendingWriterJobId && typeof onConsumeJobId === 'function') {
                    setJobId(pendingWriterJobId);
                    onConsumeJobId();
                }
            }, [pendingWriterJobId, onConsumeJobId]);

            const loadMyArticles = useCallback(async () => {
                const t = localStorage.getItem('jwt_token');
                if (!t) return;
                setLoadingArticles(true);
                try {
                    const res = await fetch('/api/writer/articles', { headers: { 'Authorization': `Bearer ${t}` } });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data.status === 'success' && Array.isArray(data.data)) {
                        setMyArticles(data.data);
                    } else {
                        if (showMessage && !res.ok) showMessage(data.message || '無法載入文章列表', 'error');
                    }
                } catch (e) {
                    if (showMessage) showMessage('無法載入文章列表', 'error');
                } finally {
                    setLoadingArticles(false);
                }
            }, [showMessage]);

            useEffect(() => {
                if (isActive) loadMyArticles();
            }, [isActive, loadMyArticles]);

            useEffect(() => {
                if (!jobId || !token) return;
                let cancelled = false;
                const poll = async () => {
                    if (cancelled) return;
                    try {
                        const res = await fetch(`/api/writer/jobs/${jobId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (cancelled) return;
                        if (!res.ok) { setTimeout(poll, 2500); return; }
                        const data = await res.json();
                        if (data.status === 'completed') {
                            setJobId(null);
                            if (data.articleId) {
                                const aRes = await fetch(`/api/writer/articles/${data.articleId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                                if (aRes.ok) {
                                    const aData = await aRes.json();
                                    setArticle(aData);
                                    if (showMessage) showMessage('文章已生成', 'success');
                                }
                                loadMyArticles();
                            }
                            return;
                        }
                        if (data.status === 'failed') {
                            setJobId(null);
                            if (showMessage) showMessage(data.error || '生成失敗', 'error');
                            return;
                        }
                    } catch (e) {
                        if (showMessage) showMessage('輪詢錯誤', 'error');
                    }
                    if (!cancelled) setTimeout(poll, 2500);
                };
                const t = setTimeout(poll, 2500);
                return () => { cancelled = true; clearTimeout(t); };
            }, [jobId, token, showMessage, loadMyArticles]);

            const handleViewArticle = async (id) => {
                try {
                    const res = await fetch(`/api/writer/articles/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.ok) {
                        const data = await res.json();
                        setArticle(data);
                    }
                } catch (e) {
                    if (showMessage) showMessage('無法載入文章', 'error');
                }
            };

            return (
                <div className="main-content">
                    <div style={{ marginBottom: '2rem' }}>
                        <h2 style={{ fontSize: '1.5rem', fontWeight: 700, marginBottom: '0.5rem' }}>寫作中心</h2>
                        <p style={{ color: 'var(--text-light)', fontSize: '0.875rem' }}>
                            在「素材夾」選擇主題的「從此主題寫文章」即可生成文章。此處僅顯示與管理已生成的文章（可查看、後續編輯）。
                        </p>
                    </div>

                    {jobId && (
                        <div style={{ marginBottom: '1rem', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: '8px' }}>
                            生成中… 請稍候
                        </div>
                    )}

                    <div style={{ marginBottom: '2rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem', flexWrap: 'wrap', gap: '0.5rem' }}>
                            <h3 style={{ fontSize: '1.125rem', fontWeight: 600, margin: 0 }}>我的文章</h3>
                            <button
                                className="btn btn-outline btn-sm"
                                onClick={() => loadMyArticles()}
                                disabled={loadingArticles}
                            >
                                {loadingArticles ? '載入中…' : '重新載入'}
                            </button>
                        </div>
                        {loadingArticles && myArticles.length === 0 ? (
                            <p style={{ color: 'var(--text-light)' }}>載入中…</p>
                        ) : myArticles.length === 0 ? (
                            <p style={{ color: 'var(--text-light)' }}>尚無文章</p>
                        ) : (
                            <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
                                {myArticles.map(a => (
                                    <li key={a._id} style={{ marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <button
                                            className="btn btn-outline btn-sm"
                                            onClick={() => handleViewArticle(a._id)}
                                        >
                                            查看
                                        </button>
                                        <span>{a.title}</span>
                                        <span style={{ color: 'var(--text-light)', fontSize: '0.875rem' }}>
                                            {a.createdAt ? new Date(a.createdAt).toLocaleDateString() : ''}
                                        </span>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>

                    {article && (
                        <div style={{ marginTop: '2rem', padding: '1.5rem', background: 'var(--bg-secondary)', borderRadius: '8px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                <h3 style={{ margin: 0 }}>{article.title}</h3>
                                <button className="btn btn-outline btn-sm" onClick={() => setArticle(null)}>關閉</button>
                            </div>
                            <div style={{ whiteSpace: 'pre-wrap', lineHeight: 1.6 }}>{article.body}</div>
                        </div>
                    )}
                </div>
            );
        }

        function PreferencesModal({ preferences, onClose, onSave, userRole }) {
            const [sources, setSources] = useState(preferences.sources || []);
            const categories = preferences.categories || []; // Read-only, managed via Admin Panel
            const [availableSources, setAvailableSources] = useState([]);
            const [defaultTimeframe, setDefaultTimeframe] = useState(preferences.defaultTimeframe || '24h');
            const [newSource, setNewSource] = useState({ type: 'rss', url: '', name: '', priority: 5 });
            const [socialHandles, setSocialHandles] = useState([]);
            const [socialHandlesOrder, setSocialHandlesOrder] = useState(preferences.socialHandlesOrder || []);
            const isAdmin = userRole === 'ADMIN';

            // Helper to get category display name
            const getCatDisplay = (cat) => typeof cat === 'object' ? cat.displayName : cat;

            // Load available sources on mount
            useEffect(() => {
                const loadAvailableSources = async () => {
                    try {
                        const token = localStorage.getItem('jwt_token');
                        const res = await fetch('/api/preferences/sources/available', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            setAvailableSources(data.data || []);
                            // Merge with user's priorities
                            if (data.data && sources.length === 0) {
                                setSources(data.data.map(s => ({ ...s, priority: s.priority || 5 })));
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load available sources:', error);
                    }
                };
                loadAvailableSources();
            }, []);

            // Load social handles on mount
            useEffect(() => {
                const loadSocialHandles = async () => {
                    try {
                        const token = localStorage.getItem('jwt_token');
                        const res = await fetch('/api/social/handles', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const handles = data.data || [];
                            setSocialHandles(handles);
                            
                            // Initialize order if not set, using current handle order from API
                            // The API already returns handles in user's preferred order (if set)
                            setSocialHandlesOrder(prevOrder => {
                                if (prevOrder.length === 0 && handles.length > 0) {
                                    // Use the order from API (which respects user preference)
                                    return handles.map(h => h._id);
                                } else if (prevOrder.length > 0) {
                                    // Ensure all current handles are in the order (add any new ones at the end)
                                    const existingIds = new Set(prevOrder.map(id => id.toString()));
                                    const newHandles = handles
                                        .filter(h => !existingIds.has(h._id.toString()))
                                        .map(h => h._id);
                                    if (newHandles.length > 0) {
                                        return [...prevOrder, ...newHandles];
                                    }
                                }
                                return prevOrder;
                            });
                        }
                    } catch (error) {
                        console.error('Failed to load social handles:', error);
                    }
                };
                loadSocialHandles();
            }, []);

            const handleSave = async () => {
                const token = localStorage.getItem('jwt_token');
                
                // Update sources (users can set priorities)
                await fetch('/api/preferences/sources', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sources })
                });

                // Note: Categories are now managed via Admin Panel (Category model)
                // Users cannot modify categories from preferences

                // Update timeframe
                await fetch('/api/preferences/timeframe', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ timeframe: defaultTimeframe })
                });

                // Update social handles order
                if (socialHandlesOrder.length > 0) {
                    await fetch('/api/preferences/social-handles-order', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ handleIds: socialHandlesOrder })
                    });
                }

                onSave({ sources, categories, defaultTimeframe, socialHandlesOrder });
            };

            const addSource = () => {
                if (newSource.url) {
                    setSources([...sources, { ...newSource }]);
                    setNewSource({ type: 'rss', url: '', name: '', priority: 5 });
                }
            };

            const removeSource = (index) => {
                setSources(sources.filter((_, i) => i !== index));
            };

            // Social handles order management
            const moveHandleUp = (index) => {
                if (index > 0) {
                    const newOrder = [...socialHandlesOrder];
                    [newOrder[index - 1], newOrder[index]] = [newOrder[index], newOrder[index - 1]];
                    setSocialHandlesOrder(newOrder);
                }
            };

            const moveHandleDown = (index) => {
                if (index < socialHandlesOrder.length - 1) {
                    const newOrder = [...socialHandlesOrder];
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                    setSocialHandlesOrder(newOrder);
                }
            };

            // Get ordered handles for display
            const getOrderedHandles = () => {
                const handleMap = new Map(socialHandles.map(h => [h._id, h]));
                const ordered = socialHandlesOrder
                    .map(id => handleMap.get(id))
                    .filter(Boolean);
                const unordered = socialHandles.filter(h => !socialHandlesOrder.includes(h._id));
                return [...ordered, ...unordered];
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">偏好設定</h2>
                            <button className="close-btn" onClick={onClose}>×</button>
                        </div>

                        <div className="form-group">
                            <label>預設時間範圍</label>
                            <select
                                className="form-control"
                                value={defaultTimeframe}
                                onChange={(e) => setDefaultTimeframe(e.target.value)}
                            >
                                <option value="24h">過去 24 小時</option>
                                <option value="7d">過去 7 天</option>
                                <option value="30d">過去 30 天</option>
                            </select>
                        </div>

                        <div className="form-group">
                            <label>
                                分類 <span style={{ fontSize: '0.75rem', color: 'var(--text-light)' }}>
                                    {isAdmin ? '(於管理面板管理)' : '(唯讀)'}
                                </span>
                            </label>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                {categories.map((cat, idx) => (
                                    <span key={idx} style={{
                                        padding: '0.25rem 0.75rem',
                                        background: 'var(--bg)',
                                        borderRadius: '20px',
                                        fontSize: '0.875rem'
                                    }}>
                                        {getCatDisplay(cat)}
                                    </span>
                                ))}
                            </div>
                        </div>

                        <div className="form-group">
                            <label>新聞來源（設定優先順序：1-10）</label>
                            <p style={{ fontSize: '0.8125rem', color: 'var(--text-light)', marginBottom: '0.5rem' }}>
                                調整優先順序以影響排名。較高優先順序的來源會優先顯示。
                            </p>
                            {sources.map((source, index) => (
                                <div key={index} style={{
                                    padding: '0.75rem',
                                    background: 'var(--bg)',
                                    borderRadius: '6px',
                                    marginBottom: '0.5rem',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    gap: '1rem'
                                }}>
                                    <div style={{ flex: 1 }}>
                                        <strong>{source.name || source.url}</strong> ({source.type})
                                        <div style={{ fontSize: '0.8125rem', color: 'var(--text-light)' }}>
                                            {source.url}
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <label style={{ fontSize: '0.8125rem' }}>優先順序:</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={source.priority || 5}
                                            onChange={(e) => {
                                                const updated = [...sources];
                                                updated[index].priority = parseInt(e.target.value) || 5;
                                                setSources(updated);
                                            }}
                                            style={{ width: '60px' }}
                                            min="1"
                                            max="10"
                                        />
                                    </div>
                                </div>
                            ))}
                            {sources.length === 0 && (
                                <p style={{ color: 'var(--text-light)', fontSize: '0.875rem' }}>
                                    沒有可用的來源。管理員需要先新增來源。
                                </p>
                            )}
                        </div>

                        <div className="form-group">
                            <label>
                                社交媒體帳號顯示順序
                                <span style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginLeft: '0.5rem' }}>
                                    (僅管理員可新增帳號)
                                </span>
                            </label>
                            <p style={{ fontSize: '0.8125rem', color: 'var(--text-light)', marginBottom: '0.5rem' }}>
                                調整社交媒體卡片在「社交主題」頁面的顯示順序。
                            </p>
                            {getOrderedHandles().map((handle, index) => {
                                const orderIndex = socialHandlesOrder.indexOf(handle._id);
                                const isInOrder = orderIndex !== -1;
                                return (
                                    <div key={handle._id} style={{
                                        padding: '0.75rem',
                                        background: 'var(--bg)',
                                        borderRadius: '6px',
                                        marginBottom: '0.5rem',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        gap: '1rem'
                                    }}>
                                        <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <span style={{ 
                                                fontSize: '0.75rem', 
                                                color: 'var(--text-light)',
                                                minWidth: '2rem',
                                                textAlign: 'center'
                                            }}>
                                                {isInOrder ? `#${orderIndex + 1}` : '未排序'}
                                            </span>
                                            <div>
                                                <strong>{handle.displayName || handle.handle}</strong>
                                                <div style={{ fontSize: '0.8125rem', color: 'var(--text-light)' }}>
                                                    @{handle.handle} ({handle.platform})
                                                </div>
                                            </div>
                                        </div>
                                        {isInOrder && (
                                            <div style={{ display: 'flex', gap: '0.25rem' }}>
                                                <button
                                                    className="btn btn-sm btn-outline"
                                                    onClick={() => moveHandleUp(orderIndex)}
                                                    disabled={orderIndex === 0}
                                                    title="上移"
                                                    style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                                >
                                                    ↑
                                                </button>
                                                <button
                                                    className="btn btn-sm btn-outline"
                                                    onClick={() => moveHandleDown(orderIndex)}
                                                    disabled={orderIndex === socialHandlesOrder.length - 1}
                                                    title="下移"
                                                    style={{ padding: '0.25rem 0.5rem', fontSize: '0.75rem' }}
                                                >
                                                    ↓
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {socialHandles.length === 0 && (
                                <p style={{ color: 'var(--text-light)', fontSize: '0.875rem' }}>
                                    沒有可用的社交媒體帳號。管理員需要先新增帳號。
                                </p>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1.5rem' }}>
                            <button className="btn btn-outline" onClick={onClose}>取消</button>
                            <button className="btn btn-primary" onClick={handleSave}>儲存</button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ onBack, showMessage }) {
            const [users, setUsers] = useState([]);
            const [sources, setSources] = useState([]);
            const [categories, setCategories] = useState([]);
            const [socialHandles, setSocialHandles] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('users');
            const [showUserForm, setShowUserForm] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [userForm, setUserForm] = useState({ name: '', password: '', role: 'USER', email: '' });
            const [sourceForm, setSourceForm] = useState({ name: '', type: 'rss', url: '', remark: '' });
            const [socialHandleForm, setSocialHandleForm] = useState({ platform: 'youtube', handle: '', instanceBaseUrl: '', displayName: '', remark: '', isActive: true });
            const [editingSocialHandle, setEditingSocialHandle] = useState(null);
            const [editSocialHandleForm, setEditSocialHandleForm] = useState({ handle: '', displayName: '', remark: '', isActive: true });
            const [autoFetchScheduleHours, setAutoFetchScheduleHours] = useState(() => Array(24).fill(false));
            const [savingSchedule, setSavingSchedule] = useState(false);
            const [togglingHandleId, setTogglingHandleId] = useState(null);
            const [newsFetchScheduleHours, setNewsFetchScheduleHours] = useState(() => Array(24).fill(false));
            const [savingNewsSchedule, setSavingNewsSchedule] = useState(false);
            const [editingSource, setEditingSource] = useState(null);
            const [editSourceForm, setEditSourceForm] = useState({ name: '', type: 'rss', url: '', remark: '', isActive: true });
            const [togglingSourceId, setTogglingSourceId] = useState(null);
            const [fetchingSourceId, setFetchingSourceId] = useState(null);

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    
                    // Load users
                    const usersRes = await fetch('/api/users', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (usersRes.ok) {
                        const usersData = await usersRes.json();
                        setUsers(usersData.data || []);
                    }

                    // Load sources
                    const sourcesRes = await fetch('/api/admin/sources', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (sourcesRes.ok) {
                        const sourcesData = await sourcesRes.json();
                        setSources(sourcesData.data || []);
                    }

                    // Load categories from admin endpoint (Category model)
                    const categoriesRes = await fetch('/api/admin/categories', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (categoriesRes.ok) {
                        const categoriesData = await categoriesRes.json();
                        setCategories(categoriesData.data || []);
                    }

                    // Load social handles
                    const socialHandlesRes = await fetch('/api/social/admin/handles', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (socialHandlesRes.ok) {
                        const socialHandlesData = await socialHandlesRes.json();
                        setSocialHandles(socialHandlesData.data || []);
                    }

                    // Load auto social fetch schedule
                    const scheduleRes = await fetch('/api/admin/social-fetch-schedule', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (scheduleRes.ok) {
                        const scheduleData = await scheduleRes.json();
                        const hours = scheduleData.data?.scheduleHours;
                        if (Array.isArray(hours) && hours.length === 24) {
                            setAutoFetchScheduleHours(hours.map(Boolean));
                        }
                    }

                    // Load news fetch schedule
                    const newsScheduleRes = await fetch('/api/admin/news-fetch-schedule', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (newsScheduleRes.ok) {
                        const newsScheduleData = await newsScheduleRes.json();
                        const newsHours = newsScheduleData.data?.scheduleHours;
                        if (Array.isArray(newsHours) && newsHours.length === 24) {
                            setNewsFetchScheduleHours(newsHours.map(Boolean));
                        }
                    }
                } catch (error) {
                    showMessage('載入資料失敗: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleCreateUser = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(userForm)
                    });

                    if (res.ok) {
                        showMessage('使用者建立成功', 'success');
                        setShowUserForm(false);
                        setUserForm({ name: '', password: '', role: 'USER', email: '' });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '建立使用者失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleDeleteUser = async (userId) => {
                if (!confirm('確定要刪除此使用者嗎？')) return;
                
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('使用者刪除成功', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '刪除使用者失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleCreateSource = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/sources', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(sourceForm)
                    });

                    if (res.ok) {
                        showMessage('來源建立成功', 'success');
                        setSourceForm({ name: '', type: 'rss', url: '', remark: '' });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '建立來源失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleDeleteSource = async (sourceId) => {
                if (!confirm('確定要刪除此來源嗎？')) return;
                
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/sources/${sourceId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('來源刪除成功', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '刪除來源失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleSaveNewsFetchSchedule = async () => {
                setSavingNewsSchedule(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/news-fetch-schedule', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ scheduleHours: newsFetchScheduleHours })
                    });
                    if (res.ok) {
                        showMessage('新聞抓取排程已儲存', 'success');
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '儲存失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                } finally {
                    setSavingNewsSchedule(false);
                }
            };

            const handleEditSource = (source) => {
                setEditingSource(source._id);
                setEditSourceForm({
                    name: source.name || '',
                    type: source.type || 'rss',
                    url: source.url || '',
                    remark: source.remark || '',
                    isActive: source.isActive !== undefined ? source.isActive : true
                });
            };

            const handleCancelEditSource = () => {
                setEditingSource(null);
                setEditSourceForm({ name: '', type: 'rss', url: '', remark: '', isActive: true });
            };

            const handleUpdateSource = async (sourceId) => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/sources/${sourceId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(editSourceForm)
                    });
                    if (res.ok) {
                        showMessage('來源更新成功', 'success');
                        setEditingSource(null);
                        setEditSourceForm({ name: '', type: 'rss', url: '', remark: '', isActive: true });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '更新失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleToggleSourceActive = async (sourceId, currentActive) => {
                setTogglingSourceId(sourceId);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/sources/${sourceId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ isActive: !currentActive })
                    });
                    if (res.ok) {
                        setSources(prev => prev.map(s => s._id === sourceId ? { ...s, isActive: !currentActive } : s));
                        showMessage(currentActive ? '已停用此來源' : '已啟用此來源', 'success');
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '更新失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                } finally {
                    setTogglingSourceId(null);
                }
            };

            const handleFetchSource = async (sourceId) => {
                if (!sourceId) {
                    showMessage('無法取得來源 ID', 'error');
                    return;
                }
                setFetchingSourceId(sourceId);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/sources/${sourceId}/fetch`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        showMessage(`已獲取 ${data.data.count} 則新聞`, 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '獲取失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                } finally {
                    setFetchingSourceId(null);
                }
            };

            const handleCreateSocialHandle = async () => {
                if (!socialHandleForm.displayName || !socialHandleForm.displayName.trim()) {
                    showMessage('顯示名稱為必填項目', 'error');
                    return;
                }
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/social/admin/handles', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(socialHandleForm)
                    });

                    if (res.ok) {
                        showMessage('社交媒體帳號建立成功', 'success');
                        setSocialHandleForm({ platform: 'youtube', handle: '', instanceBaseUrl: '', displayName: '', remark: '', isActive: true });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '建立失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleDeleteSocialHandle = async (handleId) => {
                if (!confirm('確定要刪除此社交媒體帳號嗎？')) return;
                
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/social/admin/handles/${handleId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('刪除成功', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '刪除失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleFetchSocialHandle = async (handleId) => {
                const id = (handleId && (typeof handleId === 'string' ? handleId : handleId.toString && handleId.toString())) || '';
                if (!id) {
                    showMessage('無法取得帳號 ID', 'error');
                    return;
                }
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/social/admin/handles/${id}/fetch`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        const data = await res.json();
                        showMessage(`已獲取 ${data.data.postsFetched} 則動態`, 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '獲取失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleEditSocialHandle = (handle) => {
                setEditingSocialHandle(handle._id);
                setEditSocialHandleForm({
                    handle: handle.handle || '',
                    displayName: handle.displayName || '',
                    remark: handle.remark || '',
                    isActive: handle.isActive !== undefined ? handle.isActive : true
                });
            };

            const handleCancelEdit = () => {
                setEditingSocialHandle(null);
                setEditSocialHandleForm({ handle: '', displayName: '', remark: '', isActive: true });
            };

            const handleSaveAutoFetchSchedule = async () => {
                setSavingSchedule(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/social-fetch-schedule', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ scheduleHours: autoFetchScheduleHours })
                    });
                    if (res.ok) {
                        showMessage('自動抓取排程已儲存', 'success');
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '儲存失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                } finally {
                    setSavingSchedule(false);
                }
            };

            const handleUpdateSocialHandle = async (handleId) => {
                if (!editSocialHandleForm.displayName || !editSocialHandleForm.displayName.trim()) {
                    showMessage('顯示名稱為必填項目', 'error');
                    return;
                }
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/social/admin/handles/${handleId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(editSocialHandleForm)
                    });

                    if (res.ok) {
                        showMessage('社交媒體帳號更新成功', 'success');
                        setEditingSocialHandle(null);
                        setEditSocialHandleForm({ handle: '', displayName: '', remark: '', isActive: true });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '更新失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleToggleSocialHandleActive = async (handleId, currentActive) => {
                setTogglingHandleId(handleId);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/social/admin/handles/${handleId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ isActive: !currentActive })
                    });
                    if (res.ok) {
                        setSocialHandles(prev => prev.map(h => h._id === handleId ? { ...h, isActive: !currentActive } : h));
                        showMessage(currentActive ? '已停用此帳號' : '已啟用此帳號', 'success');
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '更新失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                } finally {
                    setTogglingHandleId(null);
                }
            };

            const handleAddCategory = async (categoryName) => {
                if (!categoryName.trim()) return;
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/categories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            name: categoryName.toLowerCase().trim(),
                            displayName: categoryName.trim()
                        })
                    });

                    if (res.ok) {
                        showMessage('分類新增成功', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '新增分類失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            const handleDeleteCategory = async (categoryId) => {
                if (!confirm('確定要刪除此分類嗎？')) return;
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/categories/${categoryId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('分類刪除成功', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || '刪除分類失敗', 'error');
                    }
                } catch (error) {
                    showMessage('錯誤: ' + error.message, 'error');
                }
            };

            return (
                <div className="main-content">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h1 style={{ fontSize: '2rem' }}>管理面板</h1>
                        <button className="btn btn-outline" onClick={onBack}>← 返回儀表板</button>
                    </div>

                    <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem', borderBottom: '2px solid var(--border)' }}>
                        <button
                            className={`btn ${activeTab === 'users' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('users')}
                        >
                            👥 用戶管理
                        </button>
                        <button
                            className={`btn ${activeTab === 'sources' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('sources')}
                        >
                            📰 新聞來源
                        </button>
                        <button
                            className={`btn ${activeTab === 'categories' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('categories')}
                        >
                            📂 題目分類
                        </button>
                        <button
                            className={`btn ${activeTab === 'social' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('social')}
                        >
                            📱 社交媒體
                        </button>
                    </div>

                    {activeTab === 'users' && (
                        <div className="container">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                <h2>使用者管理</h2>
                                <button className="btn btn-primary" onClick={() => setShowUserForm(true)}>
                                    + 新增使用者
                                </button>
                            </div>

                            {showUserForm && (
                                <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                    <h3>建立新使用者</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '1rem' }}>
                                        <input
                                            type="text"
                                            className="form-control"
                                            placeholder="使用者名稱"
                                            value={userForm.name}
                                            onChange={(e) => setUserForm({ ...userForm, name: e.target.value })}
                                        />
                                        <input
                                            type="password"
                                            className="form-control"
                                            placeholder="密碼"
                                            value={userForm.password}
                                            onChange={(e) => setUserForm({ ...userForm, password: e.target.value })}
                                        />
                                        <select
                                            className="form-control"
                                            value={userForm.role}
                                            onChange={(e) => setUserForm({ ...userForm, role: e.target.value })}
                                        >
                                            <option value="USER">使用者</option>
                                            <option value="ADMIN">管理員</option>
                                        </select>
                                        <input
                                            type="email"
                                            className="form-control"
                                            placeholder="電子郵件（選填）"
                                            value={userForm.email}
                                            onChange={(e) => setUserForm({ ...userForm, email: e.target.value })}
                                        />
                                    </div>
                                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                                        <button className="btn btn-primary" onClick={handleCreateUser}>建立</button>
                                        <button className="btn btn-outline" onClick={() => {
                                            setShowUserForm(false);
                                            setUserForm({ name: '', password: '', role: 'USER', email: '' });
                                        }}>取消</button>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'grid', gap: '1rem' }}>
                                {users.map(user => (
                                    <div key={user._id} style={{
                                        padding: '1rem',
                                        background: 'var(--card-bg)',
                                        borderRadius: '8px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        border: '1px solid var(--border)'
                                    }}>
                                        <div>
                                            <strong>{user.name}</strong> ({user.role === 'ADMIN' ? '管理員' : '使用者'})
                                            {user.email && <div style={{ fontSize: '0.875rem', color: 'var(--text-light)' }}>{user.email}</div>}
                                        </div>
                                        {user.role !== 'ADMIN' && (
                                            <button
                                                className="btn btn-danger btn-sm"
                                                onClick={() => handleDeleteUser(user.name)}
                                            >
                                                刪除
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'sources' && (
                        <div className="container">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                <h2>新聞來源管理</h2>
                            </div>
                            <p style={{ color: 'var(--text-light)', marginBottom: '1rem' }}>
                                管理新聞 RSS/網站來源（與社交媒體排程分開，可獨立設定自動抓取時間）
                            </p>

                            <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>⏰ 新聞自動抓取排程</h3>
                                <p style={{ fontSize: '0.875rem', color: 'var(--text-light)', marginBottom: '1rem' }}>
                                    勾選要執行自動抓取的小時（每日在該小時會自動抓取所有已啟用的新聞來源，以伺服器當地時間為準）
                                </p>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginBottom: '1rem' }}>
                                    {Array.from({ length: 24 }, (_, i) => (
                                        <label key={i} style={{
                                            display: 'flex', alignItems: 'center', gap: '0.35rem',
                                            padding: '0.35rem 0.6rem', background: newsFetchScheduleHours[i] ? 'var(--primary)' : 'var(--card-bg)',
                                            color: newsFetchScheduleHours[i] ? 'white' : 'var(--text)',
                                            borderRadius: '6px', border: '1px solid var(--border)',
                                            cursor: 'pointer', fontSize: '0.8125rem'
                                        }}>
                                            <input
                                                type="checkbox"
                                                checked={newsFetchScheduleHours[i]}
                                                onChange={(e) => {
                                                    const next = [...newsFetchScheduleHours];
                                                    next[i] = e.target.checked;
                                                    setNewsFetchScheduleHours(next);
                                                }}
                                                style={{ margin: 0 }}
                                            />
                                            {i.toString().padStart(2, '0')}:00
                                        </label>
                                    ))}
                                </div>
                                <button
                                    className="btn btn-primary btn-sm"
                                    onClick={handleSaveNewsFetchSchedule}
                                    disabled={savingNewsSchedule}
                                >
                                    {savingNewsSchedule ? '儲存中…' : '儲存排程'}
                                </button>
                            </div>

                            <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '1rem' }}>新增新聞來源</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 2fr 1fr', gap: '1rem', marginTop: '1rem' }}>
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="名稱"
                                        value={sourceForm.name}
                                        onChange={(e) => setSourceForm({ ...sourceForm, name: e.target.value })}
                                    />
                                    <select
                                        className="form-control"
                                        value={sourceForm.type}
                                        onChange={(e) => setSourceForm({ ...sourceForm, type: e.target.value })}
                                    >
                                        <option value="rss">RSS</option>
                                        <option value="website">網站</option>
                                    </select>
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="網址"
                                        value={sourceForm.url}
                                        onChange={(e) => setSourceForm({ ...sourceForm, url: e.target.value })}
                                    />
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="備註"
                                        value={sourceForm.remark}
                                        onChange={(e) => setSourceForm({ ...sourceForm, remark: e.target.value })}
                                    />
                                </div>
                                <button className="btn btn-primary" style={{ marginTop: '1rem' }} onClick={handleCreateSource}>
                                    新增來源
                                </button>
                            </div>

                            <div style={{ display: 'grid', gap: '1rem' }}>
                                {sources.map(source => (
                                    <div key={source._id} style={{
                                        padding: '1rem',
                                        background: 'var(--card-bg)',
                                        borderRadius: '8px',
                                        border: '1px solid var(--border)'
                                    }}>
                                        {editingSource === source._id ? (
                                            <div>
                                                <h4 style={{ marginBottom: '1rem' }}>編輯新聞來源</h4>
                                                <div style={{ display: 'grid', gap: '1rem' }}>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>名稱</label>
                                                        <input
                                                            type="text"
                                                            className="form-control"
                                                            placeholder="名稱"
                                                            value={editSourceForm.name}
                                                            onChange={(e) => setEditSourceForm({ ...editSourceForm, name: e.target.value })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>類型</label>
                                                        <select
                                                            className="form-control"
                                                            value={editSourceForm.type}
                                                            onChange={(e) => setEditSourceForm({ ...editSourceForm, type: e.target.value })}
                                                        >
                                                            <option value="rss">RSS</option>
                                                            <option value="website">網站</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>網址</label>
                                                        <input
                                                            type="text"
                                                            className="form-control"
                                                            placeholder="網址"
                                                            value={editSourceForm.url}
                                                            onChange={(e) => setEditSourceForm({ ...editSourceForm, url: e.target.value })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>備註</label>
                                                        <input
                                                            type="text"
                                                            className="form-control"
                                                            placeholder="備註（選填）"
                                                            value={editSourceForm.remark}
                                                            onChange={(e) => setEditSourceForm({ ...editSourceForm, remark: e.target.value })}
                                                        />
                                                    </div>
                                                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <input
                                                            type="checkbox"
                                                            checked={editSourceForm.isActive}
                                                            onChange={(e) => setEditSourceForm({ ...editSourceForm, isActive: e.target.checked })}
                                                        />
                                                        啟用
                                                    </label>
                                                </div>
                                                <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'flex-end', marginTop: '1rem' }}>
                                                    <button
                                                        className="btn btn-outline btn-sm"
                                                        onClick={handleCancelEditSource}
                                                    >
                                                        取消
                                                    </button>
                                                    <button
                                                        className="btn btn-primary btn-sm"
                                                        onClick={() => handleUpdateSource(source._id)}
                                                    >
                                                        儲存
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '0.75rem' }}>
                                                <div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <span>{source.type === 'rss' ? '📡' : '🌐'}</span>
                                                        <strong>{source.name}</strong> ({source.type})
                                                    </div>
                                                    <div style={{ fontSize: '0.875rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                                        {source.url}
                                                        {source.remark && <span> • {source.remark}</span>}
                                                    </div>
                                                    {source.lastFetched && (
                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                                            最後更新: {new Date(source.lastFetched).toLocaleString('zh-TW')}
                                                        </div>
                                                    )}
                                                </div>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                    <button
                                                        type="button"
                                                        className="btn btn-sm"
                                                        style={{
                                                            minWidth: '4rem',
                                                            opacity: togglingSourceId === source._id ? 0.7 : 1,
                                                            background: source.isActive !== false ? 'var(--success, #28a745)' : 'var(--text-light, #6c757d)',
                                                            color: '#fff',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            padding: '0.35rem 0.6rem',
                                                            fontSize: '0.8rem',
                                                            cursor: togglingSourceId === source._id ? 'wait' : 'pointer'
                                                        }}
                                                        onClick={(e) => { e.preventDefault(); handleToggleSourceActive(source._id, source.isActive !== false); }}
                                                        disabled={togglingSourceId === source._id}
                                                        title={source.isActive !== false ? '點擊停用' : '點擊啟用'}
                                                    >
                                                        {togglingSourceId === source._id ? '…' : (source.isActive !== false ? '啟用' : '停用')}
                                                    </button>
                                                    <button
                                                        type="button"
                                                        className="btn btn-outline btn-sm"
                                                        onClick={(e) => { e.preventDefault(); handleFetchSource(source._id); }}
                                                        disabled={fetchingSourceId === source._id}
                                                        title="立即獲取新聞（僅此來源）"
                                                    >
                                                        {fetchingSourceId === source._id ? '…' : '🔄 獲取'}
                                                    </button>
                                                    <button
                                                        className="btn btn-outline btn-sm"
                                                        onClick={() => handleEditSource(source)}
                                                    >
                                                        編輯
                                                    </button>
                                                    <button
                                                        className="btn btn-danger btn-sm"
                                                        onClick={() => handleDeleteSource(source._id)}
                                                    >
                                                        刪除
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {sources.length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-light)' }}>
                                        尚未新增任何新聞來源
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'categories' && (
                        <div className="container">
                            <h2>分類管理</h2>
                            <p style={{ color: 'var(--text-light)', marginBottom: '1rem' }}>
                                管理所有使用者可用的全域分類
                            </p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginBottom: '1rem' }}>
                                {categories.map((cat) => (
                                    <span key={cat._id} style={{
                                        padding: '0.5rem 1rem',
                                        background: cat.isActive ? 'var(--bg)' : 'var(--border)',
                                        borderRadius: '20px',
                                        fontSize: '0.875rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.5rem',
                                        opacity: cat.isActive ? 1 : 0.6
                                    }}>
                                        {cat.displayName || cat.name}
                                        <button
                                            type="button"
                                            onClick={() => handleDeleteCategory(cat._id)}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                cursor: 'pointer',
                                                fontSize: '1rem'
                                            }}
                                        >×</button>
                                    </span>
                                ))}
                            </div>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <input
                                    type="text"
                                    id="newCategoryInput"
                                    className="form-control"
                                    placeholder="新增分類"
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && e.target.value) {
                                            handleAddCategory(e.target.value);
                                            e.target.value = '';
                                        }
                                    }}
                                    style={{ maxWidth: '300px' }}
                                />
                                <button className="btn btn-primary" onClick={() => {
                                    const input = document.getElementById('newCategoryInput');
                                    if (input.value) {
                                        handleAddCategory(input.value);
                                        input.value = '';
                                    }
                                }}>
                                    新增分類
                                </button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'social' && (
                        <div className="container">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                <h2>社交媒體帳號管理</h2>
                            </div>
                            <p style={{ color: 'var(--text-light)', marginBottom: '1rem' }}>
                                管理要追蹤的社交媒體帳號（YouTube、X、Instagram、Threads、Facebook）
                            </p>

                            <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '0.5rem' }}>⏰ 自動抓取排程</h3>
                                <p style={{ fontSize: '0.875rem', color: 'var(--text-light)', marginBottom: '1rem' }}>
                                    勾選要執行自動抓取的小時（每日在該小時會自動抓取所有社交媒體動態，以伺服器當地時間為準）
                                </p>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginBottom: '1rem' }}>
                                    {Array.from({ length: 24 }, (_, i) => (
                                        <label key={i} style={{
                                            display: 'flex', alignItems: 'center', gap: '0.35rem',
                                            padding: '0.35rem 0.6rem', background: autoFetchScheduleHours[i] ? 'var(--primary)' : 'var(--card-bg)',
                                            color: autoFetchScheduleHours[i] ? 'white' : 'var(--text)',
                                            borderRadius: '6px', border: '1px solid var(--border)',
                                            cursor: 'pointer', fontSize: '0.8125rem'
                                        }}>
                                            <input
                                                type="checkbox"
                                                checked={autoFetchScheduleHours[i]}
                                                onChange={(e) => {
                                                    const next = [...autoFetchScheduleHours];
                                                    next[i] = e.target.checked;
                                                    setAutoFetchScheduleHours(next);
                                                }}
                                                style={{ margin: 0 }}
                                            />
                                            {i.toString().padStart(2, '0')}:00
                                        </label>
                                    ))}
                                </div>
                                <button
                                    className="btn btn-primary btn-sm"
                                    onClick={handleSaveAutoFetchSchedule}
                                    disabled={savingSchedule}
                                >
                                    {savingSchedule ? '儲存中…' : '儲存排程'}
                                </button>
                            </div>

                            <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                <h3 style={{ marginBottom: '1rem' }}>新增社交媒體帳號</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                    <select
                                        className="form-control"
                                        value={socialHandleForm.platform}
                                        onChange={(e) => setSocialHandleForm({ ...socialHandleForm, platform: e.target.value })}
                                    >
                                        <option value="youtube">YouTube</option>
                                        <option value="x">X (Twitter)</option>
                                        <option value="instagram">Instagram</option>
                                        <option value="threads">Threads</option>
                                        <option value="facebook">Facebook</option>
                                    </select>
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="帳號（例如：@username、YouTube/X/IG/Threads 帳號，或 Facebook 個人/粉絲頁 URL 或 pageId）"
                                        value={socialHandleForm.handle}
                                        onChange={(e) => setSocialHandleForm({ ...socialHandleForm, handle: e.target.value })}
                                    />
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="顯示名稱（必填）"
                                        value={socialHandleForm.displayName}
                                        onChange={(e) => setSocialHandleForm({ ...socialHandleForm, displayName: e.target.value })}
                                        required
                                    />
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="備註（選填）"
                                        value={socialHandleForm.remark}
                                        onChange={(e) => setSocialHandleForm({ ...socialHandleForm, remark: e.target.value })}
                                    />
                                </div>
                                <button className="btn btn-primary" style={{ marginTop: '1rem' }} onClick={handleCreateSocialHandle}>
                                    新增帳號
                                </button>
                            </div>

                            <div style={{ display: 'grid', gap: '1rem' }}>
                                {socialHandles.map(handle => (
                                    <div key={handle._id} style={{
                                        padding: '1rem',
                                        background: 'var(--card-bg)',
                                        borderRadius: '8px',
                                        border: '1px solid var(--border)'
                                    }}>
                                        {editingSocialHandle === handle._id ? (
                                            <div>
                                                <h4 style={{ marginBottom: '1rem' }}>編輯社交媒體帳號</h4>
                                                <div style={{ display: 'grid', gap: '1rem' }}>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>帳號</label>
                                                        <input
                                                            type="text"
                                                            className="form-control"
                                                            placeholder="帳號"
                                                            value={editSocialHandleForm.handle}
                                                            onChange={(e) => setEditSocialHandleForm({ ...editSocialHandleForm, handle: e.target.value })}
                                                        />
                                                    </div>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>顯示名稱</label>
                                                        <input
                                                            type="text"
                                                            className="form-control"
                                                            placeholder="顯示名稱（必填）"
                                                            value={editSocialHandleForm.displayName}
                                                            onChange={(e) => setEditSocialHandleForm({ ...editSocialHandleForm, displayName: e.target.value })}
                                                            required
                                                        />
                                                    </div>
                                                    <div>
                                                        <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.875rem' }}>備註</label>
                                                        <input
                                                            type="text"
                                                            className="form-control"
                                                            placeholder="備註（選填）"
                                                            value={editSocialHandleForm.remark}
                                                            onChange={(e) => setEditSocialHandleForm({ ...editSocialHandleForm, remark: e.target.value })}
                                                        />
                                                    </div>
                                                    <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <input
                                                            type="checkbox"
                                                            checked={editSocialHandleForm.isActive}
                                                            onChange={(e) => setEditSocialHandleForm({ ...editSocialHandleForm, isActive: e.target.checked })}
                                                        />
                                                        啟用
                                                    </label>
                                                </div>
                                                <div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'flex-end', marginTop: '1rem' }}>
                                                    <button
                                                        className="btn btn-outline btn-sm"
                                                        onClick={handleCancelEdit}
                                                    >
                                                        取消
                                                    </button>
                                                    <button
                                                        className="btn btn-primary btn-sm"
                                                        onClick={() => handleUpdateSocialHandle(handle._id)}
                                                    >
                                                        儲存
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '0.75rem' }}>
                                                <div>
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                        <span>{handle.platform === 'x' ? '𝕏' : 
                                                                handle.platform === 'instagram' ? '📷' : 
                                                                handle.platform === 'threads' ? '🧵' : 
                                                                handle.platform === 'facebook' ? '📘' : '▶️'}</span>
                                                        <strong>{handle.displayName || handle.handle}</strong>
                                                    </div>
                                                    <div style={{ fontSize: '0.875rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                                        @{handle.handle}
                                                        {handle.remark && <span> • {handle.remark}</span>}
                                                    </div>
                                                    {handle.lastFetchedAt && (
                                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                                            最後更新: {new Date(handle.lastFetchedAt).toLocaleString('zh-TW')}
                                                        </div>
                                                    )}
                                                </div>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                    <button
                                                        type="button"
                                                        className="btn btn-sm"
                                                        style={{
                                                            minWidth: '4rem',
                                                            opacity: togglingHandleId === handle._id ? 0.7 : 1,
                                                            background: handle.isActive ? 'var(--success, #28a745)' : 'var(--text-light, #6c757d)',
                                                            color: '#fff',
                                                            border: 'none',
                                                            borderRadius: '6px',
                                                            padding: '0.35rem 0.6rem',
                                                            fontSize: '0.8rem',
                                                            cursor: togglingHandleId === handle._id ? 'wait' : 'pointer'
                                                        }}
                                                        onClick={(e) => { e.preventDefault(); handleToggleSocialHandleActive(handle._id, handle.isActive); }}
                                                        disabled={togglingHandleId === handle._id}
                                                        title={handle.isActive ? '點擊停用' : '點擊啟用'}
                                                    >
                                                        {togglingHandleId === handle._id ? '…' : (handle.isActive ? '啟用' : '停用')}
                                                    </button>
                                                    <button
                                                        type="button"
                                                        className="btn btn-outline btn-sm"
                                                        onClick={(e) => { e.preventDefault(); handleFetchSocialHandle(handle._id); }}
                                                        title="立即獲取動態（僅此帳號）"
                                                    >
                                                        🔄 獲取
                                                    </button>
                                                    <button
                                                        className="btn btn-outline btn-sm"
                                                        onClick={() => handleEditSocialHandle(handle)}
                                                    >
                                                        編輯
                                                    </button>
                                                    <button
                                                        className="btn btn-danger btn-sm"
                                                        onClick={() => handleDeleteSocialHandle(handle._id)}
                                                    >
                                                        刪除
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {socialHandles.length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-light)' }}>
                                        尚未新增任何社交媒體帳號
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
