<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteNews AI - Personalized News Aggregation</title>
    <!-- React & Babel CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--bg);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Login Page */
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        .login-container h2 {
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--text);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Control Panel */
        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
        }

        .control-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .select {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Topics Grid */
        .topics-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        /* Topic Card */
        .topic-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid var(--border);
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .topic-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            flex: 1;
        }

        .topic-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg);
            color: var(--primary);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }

        .topic-summary {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .topic-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.8125rem;
            color: var(--text-light);
        }

        .topic-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-icon {
            padding: 0.5rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--bg);
        }

        .btn-icon.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* News Items */
        .news-items {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .news-item {
            padding: 0.75rem;
            border-left: 3px solid var(--primary);
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .news-item-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .news-item-meta {
            font-size: 0.75rem;
            color: var(--text-light);
            display: flex;
            gap: 0.75rem;
            margin-top: 0.25rem;
        }

        .news-item-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.75rem;
        }

        .news-item-link:hover {
            text-decoration: underline;
        }

        /* Preferences Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close-btn:hover {
            background: var(--bg);
        }

        /* Messages */
        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .message-success {
            background: #d1fae5;
            color: #065f46;
        }

        .message-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .message-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .topics-grid {
                grid-template-columns: 1fr;
            }

            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [userRole, setUserRole] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [topics, setTopics] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState('');
            const [categories, setCategories] = useState([]);
            const [timeframe, setTimeframe] = useState('24h');
            const [showPreferences, setShowPreferences] = useState(false);
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [preferences, setPreferences] = useState({
                sources: [],
                categories: [],
                defaultTimeframe: '24h'
            });

            // Check if user is logged in on mount
            useEffect(() => {
                const token = localStorage.getItem('jwt_token');
                const role = localStorage.getItem('user_role');
                if (token && role) {
                    setIsLoggedIn(true);
                    setUserRole(role);
                    loadUserInfo();
                    loadPreferences();
                }
            }, []);

            // Load user info
            const loadUserInfo = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setCurrentUser(data.data);
                        setUserRole(data.data.role);
                        localStorage.setItem('user_role', data.data.role);
                    }
                } catch (error) {
                    console.error('Failed to load user info:', error);
                }
            };

            // Load preferences
            const loadPreferences = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/preferences', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setPreferences(data.data);
                        setCategories(data.data.categories || []);
                        setTimeframe(data.data.defaultTimeframe || '24h');
                    }
                } catch (error) {
                    console.error('Failed to load preferences:', error);
                }
            };

            // Login
            const handleLogin = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const username = formData.get('username');
                const password = formData.get('password');

                setLoading(true);
                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await res.json();
                    if (res.ok && data.token) {
                        localStorage.setItem('jwt_token', data.token);
                        localStorage.setItem('user_role', data.user.role);
                        setIsLoggedIn(true);
                        setUserRole(data.user.role);
                        setCurrentUser(data.user);
                        showMessage('Login successful!', 'success');
                        loadPreferences();
                    } else {
                        showMessage(data.message || 'Login failed', 'error');
                    }
                } catch (error) {
                    showMessage('Login error: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Logout
            const handleLogout = () => {
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('user_role');
                setIsLoggedIn(false);
                setUserRole(null);
                setCurrentUser(null);
                setTopics([]);
                showMessage('Logged out successfully', 'success');
            };

            // Fetch news
            const handleFetchNews = async () => {
                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/news/fetch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ timeframe })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        showMessage(`Fetched ${data.data.count} news items`, 'success');
                        // Auto-process after fetching
                        setTimeout(() => handleProcessNews(), 1000);
                    } else {
                        showMessage(data.message || 'Failed to fetch news', 'error');
                    }
                } catch (error) {
                    showMessage('Fetch error: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Process news into topics
            const handleProcessNews = async () => {
                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/news/process', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ timeframe })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        showMessage(`Created ${data.data.topics.length} topics`, 'success');
                        loadTopics();
                    } else {
                        showMessage(data.message || 'Failed to process news', 'error');
                    }
                } catch (error) {
                    showMessage('Process error: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Load topics
            const loadTopics = async (category = selectedCategory) => {
                if (!category && categories.length > 0) {
                    category = categories[0];
                }
                if (!category) {
                    setTopics([]);
                    return;
                }

                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/topics?category=${encodeURIComponent(category)}&limit=20`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const data = await res.json();
                    if (res.ok) {
                        setTopics(data.data || []);
                    } else {
                        showMessage(data.message || 'Failed to load topics', 'error');
                    }
                } catch (error) {
                    showMessage('Load error: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            // Submit feedback
            const handleFeedback = async (topicId, feedback) => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/topics/${topicId}/feedback`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ feedback })
                    });

                    if (res.ok) {
                        showMessage('Feedback recorded!', 'success');
                        loadTopics();
                    }
                } catch (error) {
                    showMessage('Feedback error: ' + error.message, 'error');
                }
            };

            // Show message
            const showMessage = (text, type = 'info') => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 5000);
            };

            // Load topics when category changes
            useEffect(() => {
                if (isLoggedIn && selectedCategory) {
                    loadTopics(selectedCategory);
                }
            }, [selectedCategory, isLoggedIn]);

            if (!isLoggedIn) {
                return <LoginPage onLogin={handleLogin} loading={loading} message={message} />;
            }

            // Show admin panel for ADMIN role
            if (userRole === 'ADMIN' && showAdminPanel) {
                return (
                    <div className="app">
                        <Header 
                            onLogout={handleLogout} 
                            onPreferences={() => setShowPreferences(true)}
                            onAdminPanel={() => setShowAdminPanel(false)}
                            userRole={userRole}
                            currentUser={currentUser}
                        />
                        {message && (
                            <div className={`message message-${message.type}`}>
                                {message.text}
                            </div>
                        )}
                        <AdminPanel 
                            onBack={() => setShowAdminPanel(false)}
                            showMessage={showMessage}
                        />
                    </div>
                );
            }

            // Show regular dashboard for all users
            return (
                <div className="app">
                    <Header 
                        onLogout={handleLogout} 
                        onPreferences={() => setShowPreferences(true)}
                        onAdminPanel={() => setShowAdminPanel(true)}
                        userRole={userRole}
                        currentUser={currentUser}
                    />
                    
                    {message && (
                        <div className={`message message-${message.type}`}>
                            {message.text}
                        </div>
                    )}

                    <div className="main-content">
                        <ControlPanel
                            categories={categories}
                            selectedCategory={selectedCategory}
                            onCategoryChange={setSelectedCategory}
                            timeframe={timeframe}
                            onTimeframeChange={setTimeframe}
                            onFetchNews={handleFetchNews}
                            onProcessNews={handleProcessNews}
                            loading={loading}
                        />

                        <TopicsSection
                            topics={topics}
                            loading={loading}
                            selectedCategory={selectedCategory}
                            onFeedback={handleFeedback}
                        />
                    </div>

                    {showPreferences && (
                        <PreferencesModal
                            preferences={preferences}
                            userRole={userRole}
                            onClose={() => setShowPreferences(false)}
                            onSave={async (newPrefs) => {
                                setPreferences(newPrefs);
                                setCategories(newPrefs.categories || []);
                                setTimeframe(newPrefs.defaultTimeframe || '24h');
                                setShowPreferences(false);
                                showMessage('Preferences saved!', 'success');
                            }}
                        />
                    )}
                </div>
            );
        }

        function LoginPage({ onLogin, loading, message }) {
            return (
                <div className="login-container">
                    <h2>LiteNews AI</h2>
                    <p style={{ textAlign: 'center', color: 'var(--text-light)', marginBottom: '1.5rem' }}>
                        AI-Powered News Aggregation
                    </p>
                    {message && (
                        <div className={`message message-${message.type}`}>
                            {message.text}
                        </div>
                    )}
                    <form onSubmit={onLogin}>
                        <div className="form-group">
                            <label htmlFor="username">Username</label>
                            <input
                                type="text"
                                id="username"
                                name="username"
                                className="form-control"
                                required
                                disabled={loading}
                                autoComplete="username"
                            />
                        </div>
                        <div className="form-group">
                            <label htmlFor="password">Password</label>
                            <input
                                type="password"
                                id="password"
                                name="password"
                                className="form-control"
                                required
                                disabled={loading}
                                autoComplete="current-password"
                            />
                        </div>
                        <button type="submit" className="btn btn-primary" style={{ width: '100%' }} disabled={loading}>
                            {loading ? 'Logging in...' : 'Login'}
                        </button>
                    </form>
                </div>
            );
        }

        function Header({ onLogout, onPreferences, onAdminPanel, userRole, currentUser }) {
            return (
                <div className="header">
                    <h1>üì∞ LiteNews AI</h1>
                    <div className="header-actions">
                        {currentUser && (
                            <span style={{ marginRight: '1rem', color: 'var(--text-light)' }}>
                                {currentUser.name} ({userRole})
                            </span>
                        )}
                        {userRole === 'ADMIN' && (
                            <button className="btn btn-outline btn-sm" onClick={onAdminPanel}>
                                üë§ Admin Panel
                            </button>
                        )}
                        <button className="btn btn-outline btn-sm" onClick={onPreferences}>
                            ‚öôÔ∏è Preferences
                        </button>
                        <button className="btn btn-secondary btn-sm" onClick={onLogout}>
                            Logout
                        </button>
                    </div>
                </div>
            );
        }

        function ControlPanel({ categories, selectedCategory, onCategoryChange, timeframe, onTimeframeChange, onFetchNews, onProcessNews, loading }) {
            return (
                <div className="control-panel">
                    <div className="control-group">
                        <label>Category:</label>
                        <select
                            className="select"
                            value={selectedCategory}
                            onChange={(e) => onCategoryChange(e.target.value)}
                            disabled={loading || categories.length === 0}
                        >
                            <option value="">Select category...</option>
                            {categories.map(cat => (
                                <option key={cat} value={cat}>{cat}</option>
                            ))}
                        </select>
                        <label>Timeframe:</label>
                        <select
                            className="select"
                            value={timeframe}
                            onChange={(e) => onTimeframeChange(e.target.value)}
                            disabled={loading}
                        >
                            <option value="24h">Last 24 hours</option>
                            <option value="7d">Last 7 days</option>
                            <option value="30d">Last 30 days</option>
                        </select>
                    </div>
                    <div className="control-group">
                        <button
                            className="btn btn-primary"
                            onClick={onFetchNews}
                            disabled={loading}
                        >
                            üì• Fetch News
                        </button>
                        <button
                            className="btn btn-success"
                            onClick={onProcessNews}
                            disabled={loading}
                        >
                            ü§ñ Process Topics
                        </button>
                    </div>
                </div>
            );
        }

        function TopicsSection({ topics, loading, selectedCategory, onFeedback }) {
            if (loading) {
                return (
                    <div className="loading">
                        <div className="spinner"></div>
                        <p>Loading topics...</p>
                    </div>
                );
            }

            if (!selectedCategory) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üìã</div>
                        <h3>Select a category to view topics</h3>
                        <p>Choose a category from the dropdown above</p>
                    </div>
                );
            }

            if (topics.length === 0) {
                return (
                    <div className="empty-state">
                        <div className="empty-state-icon">üì∞</div>
                        <h3>No topics found</h3>
                        <p>Try fetching and processing news first</p>
                    </div>
                );
            }

            return (
                <div className="topics-section">
                    <div className="section-header">
                        <h2 className="section-title">Topics: {selectedCategory}</h2>
                        <span style={{ color: 'var(--text-light)' }}>{topics.length} topics</span>
                    </div>
                    <div className="topics-grid">
                        {topics.map(topic => (
                            <TopicCard key={topic._id} topic={topic} onFeedback={onFeedback} />
                        ))}
                    </div>
                </div>
            );
        }

        function TopicCard({ topic, onFeedback }) {
            const [expanded, setExpanded] = useState(false);
            const [newsItems, setNewsItems] = useState([]);
            const [loadingItems, setLoadingItems] = useState(false);

            const loadNewsItems = async () => {
                if (newsItems.length > 0) {
                    setExpanded(!expanded);
                    return;
                }

                setLoadingItems(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/news/items?category=' + encodeURIComponent(topic.category), {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const items = data.data.filter(item => 
                            item.topicId === topic._id || topic.newsItems.includes(item._id)
                        );
                        setNewsItems(items);
                        setExpanded(true);
                    }
                } catch (error) {
                    console.error('Failed to load news items:', error);
                } finally {
                    setLoadingItems(false);
                }
            };

            return (
                <div className="topic-card">
                    <div className="topic-header">
                        <div style={{ flex: 1 }}>
                            <span className="topic-category">{topic.category}</span>
                            <h3 className="topic-title">{topic.title}</h3>
                        </div>
                    </div>
                    {topic.summary && (
                        <p className="topic-summary">{topic.summary}</p>
                    )}
                    <div className="topic-meta">
                        <span>üìä Score: {topic.finalScore || topic.discussionScore || 0}</span>
                        <span>üì∞ {topic.newsItems?.length || 0} items</span>
                    </div>
                    <div className="topic-actions">
                        <button
                            className="btn-icon"
                            onClick={() => onFeedback(topic._id, 'up')}
                            title="Like"
                        >
                            üëç
                        </button>
                        <button
                            className="btn-icon"
                            onClick={() => onFeedback(topic._id, 'down')}
                            title="Dislike"
                        >
                            üëé
                        </button>
                        <button
                            className="btn btn-outline btn-sm"
                            onClick={loadNewsItems}
                            disabled={loadingItems}
                            style={{ marginLeft: 'auto' }}
                        >
                            {expanded ? 'Hide' : 'Show'} News
                        </button>
                    </div>
                    {expanded && (
                        <div className="news-items">
                            {loadingItems ? (
                                <div style={{ textAlign: 'center', padding: '1rem' }}>Loading...</div>
                            ) : newsItems.length > 0 ? (
                                newsItems.map(item => (
                                    <div key={item._id} className="news-item">
                                        <div className="news-item-title">{item.title}</div>
                                        {item.description && (
                                            <div style={{ fontSize: '0.8125rem', color: 'var(--text-light)', marginTop: '0.25rem' }}>
                                                {item.description.substring(0, 100)}...
                                            </div>
                                        )}
                                        <div className="news-item-meta">
                                            <span>{new Date(item.publishedAt).toLocaleDateString()}</span>
                                            <span>{item.source?.name || item.source?.type}</span>
                                            {item.url && (
                                                <a href={item.url} target="_blank" rel="noopener noreferrer" className="news-item-link">
                                                    Read more ‚Üí
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div style={{ textAlign: 'center', padding: '1rem', color: 'var(--text-light)' }}>
                                    No news items found
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function PreferencesModal({ preferences, onClose, onSave, userRole }) {
            const [sources, setSources] = useState(preferences.sources || []);
            const categories = preferences.categories || []; // Read-only, managed via Admin Panel
            const [availableSources, setAvailableSources] = useState([]);
            const [defaultTimeframe, setDefaultTimeframe] = useState(preferences.defaultTimeframe || '24h');
            const [newSource, setNewSource] = useState({ type: 'rss', url: '', name: '', priority: 5 });
            const isAdmin = userRole === 'ADMIN';

            // Load available sources on mount
            useEffect(() => {
                const loadAvailableSources = async () => {
                    try {
                        const token = localStorage.getItem('jwt_token');
                        const res = await fetch('/api/preferences/sources/available', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            setAvailableSources(data.data || []);
                            // Merge with user's priorities
                            if (data.data && sources.length === 0) {
                                setSources(data.data.map(s => ({ ...s, priority: s.priority || 5 })));
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load available sources:', error);
                    }
                };
                loadAvailableSources();
            }, []);

            const handleSave = async () => {
                const token = localStorage.getItem('jwt_token');
                
                // Update sources (users can set priorities)
                await fetch('/api/preferences/sources', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ sources })
                });

                // Note: Categories are now managed via Admin Panel (Category model)
                // Users cannot modify categories from preferences

                // Update timeframe
                await fetch('/api/preferences/timeframe', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ timeframe: defaultTimeframe })
                });

                onSave({ sources, categories, defaultTimeframe });
            };

            const addSource = () => {
                if (newSource.url) {
                    setSources([...sources, { ...newSource }]);
                    setNewSource({ type: 'rss', url: '', name: '', priority: 5 });
                }
            };

            const removeSource = (index) => {
                setSources(sources.filter((_, i) => i !== index));
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">Preferences</h2>
                            <button className="close-btn" onClick={onClose}>√ó</button>
                        </div>

                        <div className="form-group">
                            <label>Default Timeframe</label>
                            <select
                                className="form-control"
                                value={defaultTimeframe}
                                onChange={(e) => setDefaultTimeframe(e.target.value)}
                            >
                                <option value="24h">Last 24 hours</option>
                                <option value="7d">Last 7 days</option>
                                <option value="30d">Last 30 days</option>
                            </select>
                        </div>

                        <div className="form-group">
                            <label>
                                Categories <span style={{ fontSize: '0.75rem', color: 'var(--text-light)' }}>
                                    {isAdmin ? '(Manage in Admin Panel)' : '(Read only)'}
                                </span>
                            </label>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                {categories.map(cat => (
                                    <span key={cat} style={{
                                        padding: '0.25rem 0.75rem',
                                        background: 'var(--bg)',
                                        borderRadius: '20px',
                                        fontSize: '0.875rem'
                                    }}>
                                        {cat}
                                    </span>
                                ))}
                            </div>
                        </div>

                        <div className="form-group">
                            <label>News Sources (Set Priority: 1-10)</label>
                            <p style={{ fontSize: '0.8125rem', color: 'var(--text-light)', marginBottom: '0.5rem' }}>
                                Adjust priority to affect ranking. Higher priority sources appear first.
                            </p>
                            {sources.map((source, index) => (
                                <div key={index} style={{
                                    padding: '0.75rem',
                                    background: 'var(--bg)',
                                    borderRadius: '6px',
                                    marginBottom: '0.5rem',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    gap: '1rem'
                                }}>
                                    <div style={{ flex: 1 }}>
                                        <strong>{source.name || source.url}</strong> ({source.type})
                                        <div style={{ fontSize: '0.8125rem', color: 'var(--text-light)' }}>
                                            {source.url}
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                        <label style={{ fontSize: '0.8125rem' }}>Priority:</label>
                                        <input
                                            type="number"
                                            className="form-control"
                                            value={source.priority || 5}
                                            onChange={(e) => {
                                                const updated = [...sources];
                                                updated[index].priority = parseInt(e.target.value) || 5;
                                                setSources(updated);
                                            }}
                                            style={{ width: '60px' }}
                                            min="1"
                                            max="10"
                                        />
                                    </div>
                                </div>
                            ))}
                            {sources.length === 0 && (
                                <p style={{ color: 'var(--text-light)', fontSize: '0.875rem' }}>
                                    No sources available. Admin needs to add sources first.
                                </p>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1.5rem' }}>
                            <button className="btn btn-outline" onClick={onClose}>Cancel</button>
                            <button className="btn btn-primary" onClick={handleSave}>Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ onBack, showMessage }) {
            const [users, setUsers] = useState([]);
            const [sources, setSources] = useState([]);
            const [categories, setCategories] = useState([]);
            const [loading, setLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('users');
            const [showUserForm, setShowUserForm] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [userForm, setUserForm] = useState({ name: '', password: '', role: 'USER', email: '' });
            const [sourceForm, setSourceForm] = useState({ name: '', type: 'rss', url: '', remark: '' });

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                setLoading(true);
                try {
                    const token = localStorage.getItem('jwt_token');
                    
                    // Load users
                    const usersRes = await fetch('/api/users', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (usersRes.ok) {
                        const usersData = await usersRes.json();
                        setUsers(usersData.data || []);
                    }

                    // Load sources
                    const sourcesRes = await fetch('/api/admin/sources', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (sourcesRes.ok) {
                        const sourcesData = await sourcesRes.json();
                        setSources(sourcesData.data || []);
                    }

                    // Load categories from admin endpoint (Category model)
                    const categoriesRes = await fetch('/api/admin/categories', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (categoriesRes.ok) {
                        const categoriesData = await categoriesRes.json();
                        setCategories(categoriesData.data || []);
                    }
                } catch (error) {
                    showMessage('Failed to load data: ' + error.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleCreateUser = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(userForm)
                    });

                    if (res.ok) {
                        showMessage('User created successfully', 'success');
                        setShowUserForm(false);
                        setUserForm({ name: '', password: '', role: 'USER', email: '' });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || 'Failed to create user', 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            };

            const handleDeleteUser = async (userId) => {
                if (!confirm('Are you sure you want to delete this user?')) return;
                
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('User deleted successfully', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || 'Failed to delete user', 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            };

            const handleCreateSource = async () => {
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/sources', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(sourceForm)
                    });

                    if (res.ok) {
                        showMessage('Source created successfully', 'success');
                        setSourceForm({ name: '', type: 'rss', url: '', remark: '' });
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || 'Failed to create source', 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            };

            const handleDeleteSource = async (sourceId) => {
                if (!confirm('Are you sure you want to delete this source?')) return;
                
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/sources/${sourceId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('Source deleted successfully', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || 'Failed to delete source', 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            };

            const handleAddCategory = async (categoryName) => {
                if (!categoryName.trim()) return;
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch('/api/admin/categories', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ 
                            name: categoryName.toLowerCase().trim(),
                            displayName: categoryName.trim()
                        })
                    });

                    if (res.ok) {
                        showMessage('Category added successfully', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || 'Failed to add category', 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            };

            const handleDeleteCategory = async (categoryId) => {
                if (!confirm('Are you sure you want to delete this category?')) return;
                try {
                    const token = localStorage.getItem('jwt_token');
                    const res = await fetch(`/api/admin/categories/${categoryId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (res.ok) {
                        showMessage('Category deleted successfully', 'success');
                        loadData();
                    } else {
                        const data = await res.json();
                        showMessage(data.message || 'Failed to delete category', 'error');
                    }
                } catch (error) {
                    showMessage('Error: ' + error.message, 'error');
                }
            };

            return (
                <div className="main-content">
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
                        <h1 style={{ fontSize: '2rem' }}>Admin Panel</h1>
                        <button className="btn btn-outline" onClick={onBack}>‚Üê Back to Dashboard</button>
                    </div>

                    <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem', borderBottom: '2px solid var(--border)' }}>
                        <button
                            className={`btn ${activeTab === 'users' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('users')}
                        >
                            üë• Users
                        </button>
                        <button
                            className={`btn ${activeTab === 'sources' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('sources')}
                        >
                            üì∞ Sources
                        </button>
                        <button
                            className={`btn ${activeTab === 'categories' ? 'btn-primary' : 'btn-outline'}`}
                            onClick={() => setActiveTab('categories')}
                        >
                            üìÇ Categories
                        </button>
                    </div>

                    {activeTab === 'users' && (
                        <div className="container">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                <h2>User Management</h2>
                                <button className="btn btn-primary" onClick={() => setShowUserForm(true)}>
                                    + Add User
                                </button>
                            </div>

                            {showUserForm && (
                                <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                    <h3>Create New User</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginTop: '1rem' }}>
                                        <input
                                            type="text"
                                            className="form-control"
                                            placeholder="Username"
                                            value={userForm.name}
                                            onChange={(e) => setUserForm({ ...userForm, name: e.target.value })}
                                        />
                                        <input
                                            type="password"
                                            className="form-control"
                                            placeholder="Password"
                                            value={userForm.password}
                                            onChange={(e) => setUserForm({ ...userForm, password: e.target.value })}
                                        />
                                        <select
                                            className="form-control"
                                            value={userForm.role}
                                            onChange={(e) => setUserForm({ ...userForm, role: e.target.value })}
                                        >
                                            <option value="USER">USER</option>
                                            <option value="ADMIN">ADMIN</option>
                                        </select>
                                        <input
                                            type="email"
                                            className="form-control"
                                            placeholder="Email (optional)"
                                            value={userForm.email}
                                            onChange={(e) => setUserForm({ ...userForm, email: e.target.value })}
                                        />
                                    </div>
                                    <div style={{ display: 'flex', gap: '0.5rem', marginTop: '1rem' }}>
                                        <button className="btn btn-primary" onClick={handleCreateUser}>Create</button>
                                        <button className="btn btn-outline" onClick={() => {
                                            setShowUserForm(false);
                                            setUserForm({ name: '', password: '', role: 'USER', email: '' });
                                        }}>Cancel</button>
                                    </div>
                                </div>
                            )}

                            <div style={{ display: 'grid', gap: '1rem' }}>
                                {users.map(user => (
                                    <div key={user._id} style={{
                                        padding: '1rem',
                                        background: 'var(--card-bg)',
                                        borderRadius: '8px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        border: '1px solid var(--border)'
                                    }}>
                                        <div>
                                            <strong>{user.name}</strong> ({user.role})
                                            {user.email && <div style={{ fontSize: '0.875rem', color: 'var(--text-light)' }}>{user.email}</div>}
                                        </div>
                                        {user.role !== 'ADMIN' && (
                                            <button
                                                className="btn btn-danger btn-sm"
                                                onClick={() => handleDeleteUser(user.name)}
                                            >
                                                Delete
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'sources' && (
                        <div className="container">
                            <h2>Source Management</h2>
                            <div style={{ padding: '1rem', background: 'var(--bg)', borderRadius: '8px', marginBottom: '1rem' }}>
                                <h3>Add New Source</h3>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 2fr 1fr', gap: '1rem', marginTop: '1rem' }}>
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="Name"
                                        value={sourceForm.name}
                                        onChange={(e) => setSourceForm({ ...sourceForm, name: e.target.value })}
                                    />
                                    <select
                                        className="form-control"
                                        value={sourceForm.type}
                                        onChange={(e) => setSourceForm({ ...sourceForm, type: e.target.value })}
                                    >
                                        <option value="rss">RSS</option>
                                        <option value="website">Website</option>
                                    </select>
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="URL"
                                        value={sourceForm.url}
                                        onChange={(e) => setSourceForm({ ...sourceForm, url: e.target.value })}
                                    />
                                    <input
                                        type="text"
                                        className="form-control"
                                        placeholder="Remark"
                                        value={sourceForm.remark}
                                        onChange={(e) => setSourceForm({ ...sourceForm, remark: e.target.value })}
                                    />
                                </div>
                                <button className="btn btn-primary" style={{ marginTop: '1rem' }} onClick={handleCreateSource}>
                                    Add Source
                                </button>
                            </div>

                            <div style={{ display: 'grid', gap: '1rem' }}>
                                {sources.map(source => (
                                    <div key={source._id} style={{
                                        padding: '1rem',
                                        background: 'var(--card-bg)',
                                        borderRadius: '8px',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        border: '1px solid var(--border)'
                                    }}>
                                        <div>
                                            <strong>{source.name}</strong> ({source.type})
                                            <div style={{ fontSize: '0.875rem', color: 'var(--text-light)' }}>
                                                {source.url} {source.remark && `‚Ä¢ ${source.remark}`}
                                            </div>
                                        </div>
                                        <button
                                            className="btn btn-danger btn-sm"
                                            onClick={() => handleDeleteSource(source._id)}
                                        >
                                            Delete
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {activeTab === 'categories' && (
                        <div className="container">
                            <h2>Category Management</h2>
                            <p style={{ color: 'var(--text-light)', marginBottom: '1rem' }}>
                                Manage global categories available to all users
                            </p>
                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', marginBottom: '1rem' }}>
                                {categories.map((cat) => (
                                    <span key={cat._id} style={{
                                        padding: '0.5rem 1rem',
                                        background: cat.isActive ? 'var(--bg)' : 'var(--border)',
                                        borderRadius: '20px',
                                        fontSize: '0.875rem',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '0.5rem',
                                        opacity: cat.isActive ? 1 : 0.6
                                    }}>
                                        {cat.displayName || cat.name}
                                        <button
                                            type="button"
                                            onClick={() => handleDeleteCategory(cat._id)}
                                            style={{
                                                background: 'none',
                                                border: 'none',
                                                cursor: 'pointer',
                                                fontSize: '1rem'
                                            }}
                                        >√ó</button>
                                    </span>
                                ))}
                            </div>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <input
                                    type="text"
                                    id="newCategoryInput"
                                    className="form-control"
                                    placeholder="Add category"
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter' && e.target.value) {
                                            handleAddCategory(e.target.value);
                                            e.target.value = '';
                                        }
                                    }}
                                    style={{ maxWidth: '300px' }}
                                />
                                <button className="btn btn-primary" onClick={() => {
                                    const input = document.getElementById('newCategoryInput');
                                    if (input.value) {
                                        handleAddCategory(input.value);
                                        input.value = '';
                                    }
                                }}>
                                    Add Category
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
